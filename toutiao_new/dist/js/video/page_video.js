FastClick.attach(document.body),$(function(){function t(){o=$('<div id="J_gg_video" class="gg-video"><div class="gg"></div><a id="J_gg_close_video" class="gg-close-video">关闭广告</a></div>'),o.appendTo(r.parents(".video-wrap")),i=o.find("#J_gg_close_video")}function e(){var t=document.createElement("div"),e=document.createElement("script"),a=document.createElement("script"),i="u2643659";t.id="bdUserDefInlay_"+i,e.type="text/javascript",e.innerHTML='var cpro_id = "'+i+'";',a.type="text/javascript",a.src="http://cpro.baidustatic.com/cpro/ui/cm.js",o.children(".gg").append(t).append(e).append(a)}function a(){this.qid=GLOBAL.Util.getQueryString("qid")||Cookies.get("qid")||"null",this.userId=Cookies.get("user_id"),this.osType=GLOBAL.Util.getOsType(),this.browserType=GLOBAL.Util.getBrowserType(),this.init()}var i=null,o=null,n=null,r=$("#J_video"),d=$("#J_related"),s=$("#J_commend"),l=0,p=$('<div class="loading"><div class="spinner"><div class="bounce1"></div> <div class="bounce2"></div> <div class="bounce3"></div></div><p class="txt">更多视频加载中</p></div>'),c="http://toutiao.eastday.com/getwapdata/getuid",u="http://toutiao.eastday.com/getwapdata/data",g="http://toutiao.eastday.com/getwapdata/videoact",v="http://toutiao.eastday.com/pjson/morevideos",y="http://ot.dftoutiao.com/online/online",m=10;a.prototype.init=function(){var a=this;a.qid?a._setQid(a.qid):Cookies.remove("qid",{path:"/",domain:"eastday.com"}),a.userId||(a.userId=+new Date+Math.random().toString(10).substring(2,6),Cookies.set("user_id",a.userId,{expires:365,path:"/",domain:"eastday.com"})),a.addVideoListener(),a.getVideoList(),a._addLog(),a._addOnlineLog(),setInterval(function(){a._addOnlineLog()},1e3*m),d.on("click","a",function(){r[0].pause(),a.removeLoading()}),r.attr("preload",!0),r.attr("autobuffer",!0),r.attr("x-webkit-airplay","allow"),t(),e(),i.on("click",function(){a.hideGg()}),"wnwifishipin"===a.qid&&s.after('<div id="wkssp-container1"></div><div id="wkssp-container2"></div><div id="wkssp-container3"></div><div id="wkssp-container4"></div><div id="wkssp-container5"></div><script type="text/javascript"> window._wksspid = "www.eastday.com"; var url = "http://static.51y5.net/znews/static/ad/external_detail_ad.js?t=" + parseInt(new Date().getTime() / 3600000); var scr = document.createElement("script"); scr.src = url; document.querySelector("head").appendChild(scr); </script>')},a.prototype.getVideoList=function(t){var e=this;$.ajax({url:v,data:{type:$("#J_video").attr("data-type"),num:"10",qid:e.qid,recgid:e.userId,url:GLOBAL.Util.getUrlNoParams()},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){d.append(p)},success:function(t){e.generateVideoList(t)},error:function(t){console.error(t)},complete:function(e,a){t&&t(),"timeout"===a&&d.append('<p style="padding: 0.1rem 0 0.2rem; font-size: 0.24rem; color: #999; text-align: center; margin-top: 0.2rem;">请求超时，请检查网络连接状态或<a href="javascript:location.reload();">刷新页面</a>重试。</p>'),p&&p.remove()}})},a.prototype.generateVideoList=function(t){var e=this,a=t.data?t.data:null,i=a?a.length:0,o=$('<div class="related-cnt"></div>');if(i>0){d.append('<div class="related-tit"><h2>相关视频</h2></div>');for(var n=0;i>n;n++){var r=a[n],s=r.miniimg_01,l=s[0],p=n+1,c=GLOBAL.Util.getUrlNoParams(),u=r.url+"?qid="+e.qid+"&idx="+p+"&fr="+c,g=r.type,v=r.topic,y=r.source,m=l.src,h=l.imgwidth,f=l.imgheight,w=GLOBAL.Util.msToTimestr(r.videoalltime);o.append('<section class="news-item news-item-video"><a data-type="'+g+'" data-subtype="" href="'+u+'"><div class="news-wrap clearfix"><div class="txt-wrap fl"><h3>'+v+'</h3> <p><em class="fl">'+y+'</em></p></div><div class="img-wrap fr"><img class="lazy" src="'+m+'" alt="" data-width="'+h+'" data-height="'+f+'"><span class="duration">'+w+"</span></div></div></a></section>")}}o.appendTo(d)},a.prototype.sendVideoLog=function(t){t&&$.ajax({url:g,data:{param:encodeURIComponent(t)},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){}})},a.prototype.showLoading=function(){n=$('<div class="video-loading"><div class="img"></div><div class="ball-beat"><div></div> <div></div> <div></div></div></div>'),n.appendTo(r.parents(".video-wrap"))},a.prototype.removeLoading=function(){n&&n.remove()},a.prototype.play=function(){var t=this,e=t.getEnd(),a=r[0];l>=3&&.01>=e?(a.play(),l=0,t.removeLoading()):5>=e?(n||t.showLoading(),setTimeout(function(){t.play(),l++},1e3)):(t.removeLoading(),a.play())},a.prototype.getEnd=function(){var t=r[0],e=0;try{e=t.buffered.end(0)||0,e=parseInt(1e3*e+1,10)/1e3}catch(a){}return e},a.prototype.addVideoListener=function(){var t=this;r.one("play",function(e){t.showLoading();var a=setInterval(function(){var e=r[0];Math.floor(1e3*e.currentTime)<100||(t.removeLoading(),clearInterval(a))},200)}),r.on("playing",function(e){try{var a=$(e.target),o=a[0],n=o.currentSrc,r=o.duration?Math.floor(1e3*o.duration):a.attr("data-duration"),d=a.attr("data-idx"),s=a.attr("data-type"),l=a.attr("data-playingTime")?a.attr("data-playingTime"):"null",p=Math.floor(1e3*o.currentTime),c=t.qid+"	"+t.userId+"	news	eastday_wapnews	null	"+(s||"null")+"	"+t.osType+"	"+(d||"null")+"	"+t.browserType+"	"+n+"	"+r+"	"+l+"	"+p+"	play";a.attr("data-updateTime",+new Date),t.sendVideoLog(c)}catch(u){console.log("Event playing has error!!!",u)}i&&i.trigger("click")}),r.on("pause",function(e){try{var a=$(e.target),i=a[0],o=i.currentSrc,n=i.duration?Math.floor(1e3*i.duration):a.attr("data-duration"),d=a.attr("data-idx"),s=a.attr("data-type"),l=a.attr("data-playingTime")?a.attr("data-playingTime"):"null",p=Math.floor(1e3*i.currentTime),c=t.qid+"	"+t.userId+"	news	eastday_wapnews	null	"+s+"	"+t.osType+"	"+(d||"null")+"	"+t.browserType+"	"+o+"	"+n+"	"+l+"	"+p+"	pause";t.sendVideoLog(c),Math.floor(1e3*r[0].currentTime)>1e3&&r[0].paused&&t.showGg()}catch(u){console.log("Event pause has error!!!",u)}}),r.on("timeupdate",function(t){try{var e=$(t.target),a=parseInt(e.attr("data-updateTime"),10)||+new Date,i=parseInt(e.attr("data-playingTime"),10)||0,o=+new Date;i=i+o-a,e.attr("data-playingTime",i),e.attr("data-updateTime",o)}catch(n){console.log("Event timeupdate has error!!!",n)}})},a.prototype.showGg=function(){o&&(o.show(),r.css({width:1,height:1}))},a.prototype.hideGg=function(){o&&(o.hide(),r.css({width:"100%",height:"100%"}))},a.prototype._addLog=function(){var t=GLOBAL.Util.getPixel(),e=this;$.ajax({url:u,data:{qid:e.qid||"null",uid:e.userId||"null",softtype:"news",softname:"eastday_wapnews",newstype:$("#J_video").attr("data-type")||"null",from:GLOBAL.Util.getQueryString("fr")||"null",to:GLOBAL.Util.getUrlNoParams()||"null",os_type:e.osType||"null",browser_type:e.browserType||"null",pixel:t.w+"*"+t.h,fr_url:GLOBAL.Util.getReferrer()||"null",loginid:"null",ime:"null",idx:GLOBAL.Util.getQueryString("idx"),ishot:GLOBAL.Util.getQueryString("ishot")||"null",ver:"null",appqid:"null",ttloginid:"null",apptypeid:"null",appver:"null",recommendtype:GLOBAL.Util.getQueryString("recommendtype")||"null",ispush:GLOBAL.Util.getQueryString("ispush")||"null"},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},a.prototype._addOnlineLog=function(){var t=this,e=GLOBAL.Util.getUrlNoParams()+"	"+t.userId+"	"+t.qid+"	null	null	null	"+($("#J_video").attr("data-type")||"null")+"	"+m+"	null	null	"+t.osType+"	null";$.ajax({url:y,data:{param:encodeURI(e)},dataType:"jsonp",jsonp:"jsonpcallback"})},a.prototype._setQid=function(t){Cookies.set("qid",t,{expires:3,path:"/",domain:"eastday.com"})},a.prototype._getQid=function(){var t=Cookies.get("qid");return t?t:""},a.prototype._setUid=function(t){var e=this;t?(e.userId=t,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})):$.ajax({url:c,dataType:"jsonp",data:{softtype:"news",softname:"eastday_wapnews"},jsonp:"jsonpcallback",success:function(t){try{e.userId=t.uid,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})}catch(a){console.error(a)}},error:function(t){console.error(t)}})},new a});