$(function(){function e(){var e=U.get("current_newstype");this.newsType=e?e:"toutiao",this.readUrl="",this.userId="",this.idx=0,this.pgNum=1,this.pulldown_pgNum=0,this.pulldown_idx=0,this.pulldown_num=0,this.qid=getQueryString("qid"),this.pullUpFlag=!0,this.startKey="",this.endKey="",this.osType=getOsType(),this.browserType=getBrowserType(),this.init()}FastClick.attach(document.body);var t="http://toutiao.eastday.com/toutiao_h5/RefreshJP",a="http://toutiao.eastday.com/toutiao_h5/pulldown",s="http://toutiao.eastday.com/toutiao_h5/NextJP",n="http://position.dfshurufa.com/position/get",i="http://toutiao.eastday.com/getwapdata/getuid",r="http://toutiao.eastday.com/pjson/zan",l="http://toutiao.eastday.com/getwapdata/data",o="http://ot.dftoutiao.com/online/online",p="http://toutiao.eastday.com/getwapdata/advshow",d="http://toutiao.eastday.com/getwapdata/ad",c=$("body"),u=[],m=[],f=$("#J_news_list"),g=$("#J_refresh"),y=$("#J_top_menu"),w=!0,h=0,v=0,_=!0,T=!1,x=!1,k=null,b=200,j=null,U=new WebStorageCache;e.prototype={init:function(){function e(e,a,s){var n=e.data("rowkey"),i=t.getPraiseTrampleStatus(n);return 1===i?void alert("您已经赞过了！"):-1===i?void alert("您已经踩过了！"):void(w&&(w=!1,e.addClass("active").text(Number(e.text())+1),$.ajax({url:r,dataType:"jsonp",data:{colname:a,rowkey:n,praisecnt:1},jsonp:"jsonpcallback",success:function(e){t.cachePraiseTrampleRowkey(s,n),w=!0},error:function(e){console.error(e)}})))}var t=this;t.qid?t.setQid(t.qid):Cookies.remove("qid",{path:""}),t.userId=t.getUid(),t.userId||t.setUid(),t.readUrl=U.get("read_url_all"),t.readUrl||(t.readUrl=""),t.initChannels(function(){var e=y.children("a");e.each(function(){var e=$(this),t=e.data("type");u.push(t),"meinv"!==t&&"nuanwen"!==t&&m.push(t)}),e.each(function(){var e=$(this);return e.data("type")==t.newsType?(t.scrollTo(e,!1),!1):void 0}),U.get("location")?t.updateDomLocation(U.get("location")):t.location()}),t.refreshData(function(){t.highlightPraiseTrample()}),t.addLog(),t.pullDown(),y.on("click","a",function(){var e=$(this),a=e.data("type");t.scrollTo(e,!1),U.set("prev_newstype",t.newsType,{exp:1200}),U.set("current_newstype",a,{exp:1200}),t.newsType=a,t.refreshData(function(){t.highlightPraiseTrample()}),t.addLog()}),$(window).on("scroll",function(){var e=getScrollTop(),a=$("#J_loading").offset().top,s=getClientHeight(),n=null;n&&clearTimeout(n),n=setTimeout(function(){U.set("news_pos_"+t.newsType,e,{exp:1200})},200),a>=s&&e+s>=a&&t.pullUpFlag&&t.pullUpLoadData()}),g.on("click",function(){g.hasClass("active")||(t.changeRefreshStatus(),U["delete"]("news_pos_"+t.newsType),U["delete"]("news_"+t.newsType),t.refreshData(function(){t.highlightPraiseTrample()}))}),f.on("click","a",function(e){var a=$(this),s=a.attr("href");s=s.substring(s.indexOf("/mobile/")+8,s.indexOf(".html")),t.cacheReadUrl(s,a.data("type"),a.data("subtype"))}),c.on("click",".J-read-position",function(){var e=setInterval(function(){c.scrollTop(c.scrollTop()-20),c.scrollTop()<=0&&(clearInterval(e),t.changeRefreshStatus(),t.pullDownLoadData())},1)}),c.on("click",".J-promote-news",function(){var e=$(this),a=e.attr("href"),s=e.data("advid");t.sendPromoteNewslog(a,s)}),f.on("click",".J-good",function(){e($(this),"z0000",1)}),f.on("click",".J-bad",function(){e($(this),"zd0000",-1)}),t.addOnlineLog(),setInterval(function(){t.addOnlineLog()},1e4)},changeRefreshStatus:function(){g.addClass("active"),setTimeout(function(){g.removeClass("active")},700)},initChannels:function(e){var t=this,a=U.get("news_channels");a?(t.generateChannelTabs(a),e&&e()):$.ajax({url:"data/channels.json",dataType:"json",success:function(a){t.generateChannelTabs(a.channels.up),e&&e()},error:function(){console.error(arguments)}})},sendPromoteNewslog:function(e,t){var a=this,s=getPixel();$.ajax({url:d,dataType:"jsonp",data:{qid:a.qid||"null",uid:a.userId||"null",loginid:"null",softtype:"news",softname:"eastday_wapnews",newstype:"ad",from:"null",to:e||"null",os_type:getOsType()||"null",browser_type:getBrowserType()||"null",pixel:s.w+"*"+s.h,ime:"null",refer:getReferrer()||"null",adv:t||"null"},jsonp:"jsonpcallback",success:function(e){}})},generateChannelTabs:function(e){if(e&&e instanceof Array){for(var t="",a=0;a<e.length;a++)t+=0===a?'<a class="active" data-type="'+e[a].name+'">'+e[a].value+"</a>":'<a data-type="'+e[a].name+'">'+e[a].value+"</a>";y.html(t),U.set("news_channels",e)}},getMyChannels:function(e,t){if(!e||!t)return[];for(var a=new Array,s=t.length,n=e.length,i=0;s>i;i++)for(var r=0;n>r;r++)t[i].name==e[r].name&&a.push(t[i]);return a},pullDown:function(){var e=this,t=0;f.on("touchstart",function(e){clearTimeout(j),h=e.touches[0].pageY,x=c.scrollTop()<=0,k?k.removeClass("active").css({display:"block",opacity:0,top:t,transform:"translateY(0px)","-webkit-transform":"translateY(0px)"}):(t=$("header").height()-40,k=$('<svg id="J_svg" class="svg" style="top: '+t+'px"><g id="J_svg_g"><marker id="J_svg_marker" markerWidth="10" markerHeight="10" refX="0" refY="5" orient="auto" markerUnits="userSpaceOnUse"><path d="M0,0 L0,10 L5,5 L0,0" style="fill: #d43d3d;"></path></marker><path stroke-width="3.5" stroke-linecap="round" id="J_svg_path" marker-end="url(#J_svg_marker)" d="M20,9 A11,11 0 1,1 10.5,14.5" style="stroke: #d43d3d; fill: none;"></path><circle id="J_svg_circle" class="path" fill="none" stroke-width="3.5" stroke-linecap="round" cx="25" cy="25" r="11"></circle></g></svg>'))}),f.on("touchend",function(){v===b?(k&&k.addClass("active"),clearTimeout(j),j=setTimeout(function(){"meinv"==e.newsType?(g.trigger("click"),k&&k.remove()):e.pullDownLoadData(function(){k&&k.remove()})},400)):k&&k.animate({opacity:0,top:t},"fast",function(){k.remove()}),_=!0,T=!1}),f.on("touchmove",function(e){var a=e.touches[0].pageY;v=a-h,_&&v>0&&(T=!0,_=!1),x&&T&&(0===c.find(".svg").length&&k.appendTo("body"),v>=b?(k.find("#J_svg_marker>path").attr("style","fill:#2a90d7"),k.find("#J_svg_g>path").attr("style","stroke:#2a90d7;fill:none"),v=b):(k.find("#J_svg_marker>path").attr("style","fill:#d43d3d"),k.find("#J_svg_g>path").attr("style","stroke:#d43d3d;fill:none")),k.css({opacity:v/b,transform:"rotate("+v/b*360+"deg)","-webkit-transform":"rotate("+v/b*360+"deg)",top:t+v/3+"px"}),e.preventDefault())})},pullDownLoadData:function(e){var t=this;t.readUrl=t.getReadUrl(),t.pulldown_pgNum=Number(U.get("pulldown_pgnum_"+t.newsType)),U.set("pulldown_pgnum_"+t.newsType,--t.pulldown_pgNum,{exp:86400}),t.pulldown_idx=Number(U.get("pulldown_idx_"+t.newsType)),t.pulldown_idx||(t.pulldown_idx=0),$.ajax({url:a,data:{type:t.newsType,startkey:U.get("startkey_"+t.newsType),lastkey:U.get("endkey_"+t.newsType),pgnum:t.pulldown_pgNum,idx:t.pulldown_idx,readhistory:t.readUrl,recgid:t.userId,qid:t.qid,os:t.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){},success:function(e){t.generateDomForPulldown(e)},error:function(e){console.error(e)},complete:function(){e&&e()}})},getReadUrl:function(){var e=this,t="";return t="toutiao"==e.newsType||"weikandian"==e.newsType?U.get("read_url_all"):U.get("read_url_"+e.newsType),t?t:null},generateDomForPulldown:function(e){var t=this,a=e&&e.data,s=a.length;if(!a||!a.length)return!1;t.pulldown_num++,U.set("startkey_"+t.newsType,e.endkey,{exp:86400}),U.set("endkey_"+t.newsType,e.newkey,{exp:86400}),a.reverse(),c.find(".J-read-position").remove(),f.prepend('<a class="J-read-position read-position">上次浏览到这里，点击刷新。</a>');for(var n=0;s>n;n++){var i=a[n],r=i.url,l=i.date,o=i.topic,p=i.source,d=i.miniimg,u=i.recommendtype?i.recommendtype:"-1",m=i.hotnews,g=i.ispicnews,y=i.isadv||"",w=i.adv_id||"",h=i.type,v=i.subtype,_=d.length,T=(i.rowkey,Number(i.hotnews)),x=Number(i.isvideo),k=Number(i.isrecom),b=Number(i.isnxw),j=(i.urlpv,i.picnums,i.praisecnt,i.tramplecnt,""),J="";"1"==y?(J='<i class="promote">推广</i>',j='class="J-promote-news" data-advid="'+w+'"',t.sendAdShowLog(w,r)):T?(J='<i class="hot">热门</i>',x&&(J+='<i class="video">视频</i>')):k?J='<i class="rec">推荐</i>':x?J='<i class="video">视频</i>':b&&(J='<i class="nuanwen">暖文</i>'),r+="meinv"==t.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(t.pulldown_idx-n-1)+"&recommendtype="+u+"&ishot="+m+"&fr="+t.newsType,"1"==g?(d=i.lbimg,f.prepend('<section class="news-item news-item-s3"><a '+j+' data-type="'+h+'" data-subtype="'+v+'" href="'+r+'"><div class="news-wrap"><h3>'+o+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+d[0].src+'" alt="'+d[0].alt+'"></div><p class="clearfix"><em class="fl">'+(J?J:getSpecialTimeStr(l))+'</em><em class="fr">'+p+"</em></p></div></a></section>")):_>=3?f.prepend('<section class="news-item news-item-s2"><a '+j+' data-type="'+h+'" data-subtype="'+v+'" href="'+r+'"><div class="news-wrap"><h3>'+o+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+d[0].src+'" alt="'+d[0].alt+'"></div><div class="img fl"><img class="lazy" src="'+d[1].src+'" alt="'+d[1].alt+'"></div><div class="img fl"><img class="lazy" src="'+d[2].src+'" alt="'+d[2].alt+'"></div></div><p class="clearfix"><em class="fl">'+(J?J:getSpecialTimeStr(l))+'</em><em class="fr">'+p+"</em></p></div></a></section>"):f.prepend('<section class="news-item news-item-s1"><a '+j+' data-type="'+h+'" data-subtype="'+v+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+o+'</h3> <p><em class="fl">'+(J?J:getSpecialTimeStr(l))+'</em><em class="fr">'+p+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+d[0].src+'" alt="'+d[0].alt+'"></div></div></a></section>')}var S=$('<p id="J_recommend_news" class="recommend-news">为您推荐<span>'+s+"</span>条新闻</p>");if(S.appendTo("body"),setTimeout(function(){S.fadeOut("slow",function(){S.remove()})},1e3),t.pulldown_num>=20){t.pulldown_num=0;for(var C=f.children(),L=C.length,n=L-1;n>=L-20;n--)C[n].remove()}U.set("pulldown_idx_"+t.newsType,t.pulldown_idx-s,{exp:1200}),U.set("news_"+t.newsType,f.html(),{exp:1200})},sendAdShowLog:function(e,t){var a=this,s=getPixel();$.ajax({url:p,dataType:"jsonp",data:{qid:a.qid||"null",uid:a.userId||"null",loginid:"null",softtype:"news",softname:"eastday_wapnews",newstype:"ad",from:"null",advurl:t||"null",os_type:getOsType()||"null",browser_type:getBrowserType()||"null",fr_url:"null",pixel:s.w+"*"+s.h,ime:"null",adv:e||"null"},jsonp:"jsonpcallback",success:function(e){}})},highlightPraiseTrample:function(){var e=this;"meinv"==e.newsType&&(f.find(".J-good").each(function(){var t=$(this);1===e.getPraiseTrampleStatus(t.data("rowkey"))&&t.addClass("active")}),f.find(".J-bad").each(function(){var t=$(this);-1===e.getPraiseTrampleStatus(t.data("rowkey"))&&t.addClass("active")}))},getPraiseTrampleStatus:function(e){var t=U.get("praise_rowkey"),a=U.get("trample_rowkey");return t&&-1!=t.indexOf(e)?1:a&&-1!=a.indexOf(e)?-1:0},cachePraiseTrampleRowkey:function(e,t){var a=U.get("praise_trample_rowkey"),s=U.get("praise_rowkey"),n=U.get("trample_rowkey");a?a+=","+t:a=t,U.set("praise_trample_rowkey",a,{exp:31536e3}),1===e?(s?s+=","+t:s=t,U.set("praise_rowkey",s,{exp:31536e3})):(n?n+=","+t:n=t,U.set("trample_rowkey",n,{exp:31536e3}))},location:function(){var e=this;$.ajax({url:n,dataType:"jsonp",jsonp:"jsonpcallback",success:function(t){try{var a=t.position,s=e.getCityPinyin(a.provname),n=null;s&&(n={prov_id:a.pro_id,prov_py:s,prov_name:a.provname},e.updateDomLocation(n),U.set("location",n,{exp:2592e3}))}catch(i){console.error(i)}},error:function(e,t){console.error(t)}})},updateDomLocation:function(e){y.children("a").eq(1).after('<a data-type="'+e.prov_py+'">'+e.prov_name+"</a>")},getCityPinyin:function(e){switch(e){case"上海":return"shanghai";case"北京":return"beijing";case"河南":return"henan";case"广东":return"guangdong";default:return null}},cacheReadUrl:function(e,t,a){var s=this;if(!s.existReadUrl(e)&&m.contains(t)){var n=U.get("read_url_all");if(n){for(n=n.split(",");n.length>=5;)n.shift();n.push(e),s.readUrl=n.join(",")}else s.readUrl=e;U.set("read_url_all",s.readUrl,{exp:259200});var i=U.get("read_url_"+t);if(i){for(i=i.split(",");i.length>=3;)i.shift();i.push(e),i=i.join(",")}else i=e;if(U.set("read_url_"+t,i,{exp:259200}),a){var r=U.get("read_url_"+a);if(r){for(r=r.split(",");r.length>=3;)r.shift();r.push(e),r=r.join(",")}else r=e;U.set("read_url_"+a,r,{exp:259200})}}},existReadUrl:function(e){var t=U.get("read_url_all");return!(!t||-1===t.indexOf(e))},clearPosition:function(e){U["delete"]("news_pos_"+e)},scrollTo:function(e,t){var a=y.children("a"),s=y.scrollLeft(),n=e[0].offsetLeft-3*a.eq(0).width(),i=s-n,r=null;a.removeClass("active"),e.addClass("active"),t?r=0>=i?setInterval(function(){s>=n&&clearInterval(r),s+=3,y.scrollLeft(s)},1):setInterval(function(){n>=s&&clearInterval(r),s-=3,y.scrollLeft(s)},1):y.scrollLeft(n)},setQid:function(e){e&&Cookies.set("qid",e,{expires:3,path:"/",domain:"eastday.com"})},getQid:function(){var e=Cookies.get("qid");return e?e:""},setUid:function(){var e=this;$.ajax({url:i,dataType:"jsonp",data:{softtype:"news",softname:"eastday_wapnews"},jsonp:"jsonpcallback",success:function(t){try{e.userId=t.uid,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})}catch(a){console.error(a)}},error:function(e){console.error(e)}})},getUid:function(){var e=Cookies.get("user_id");return e?e:""},addLog:function(){var e=getPixel(),t=this;$.ajax({url:l,data:{qid:t.qid||"null",uid:t.userId||"null",softtype:"news",softname:"eastday_wapnews",newstype:t.newsType||"null",from:U.get("prev_newstype")||"null",to:U.get("current_newstype")||"null",os_type:getOsType()||"null",browser_type:getBrowserType()||"null",pixel:e.w+"*"+e.h,fr_url:getReferrer()||"null",loginid:"null",ime:"null",idx:"null",ishot:"null",ver:"null",appqid:"null",ttloginid:"null",apptypeid:"null",appver:"null",recommendtype:"null",ispush:"null"},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},addOnlineLog:function(){var e=this,t=getUrlNoParams()+"	"+e.userId+"	"+e.qid+"	null	null	null	"+e.newsType+"	null	null	"+getOsType()+"	null";$.ajax({url:o,data:{param:encodeURI(t)},dataType:"jsonp",jsonp:"jsonpcallback"})},refreshData:function(e){var a=this,s=U.get("news_"+a.newsType),n=U.get("news_pos_"+a.newsType);s?(f.html(s),n&&c.scrollTop(n)):(U["delete"]("pulldown_idx_"+a.newsType),U.set("pgnum_"+a.newsType,1,{exp:1200}),a.readUrl=a.getReadUrl(),$.ajax({url:t,data:{type:a.newsType,recgid:a.userId,qid:a.qid,picnewsnum:1,readhistory:a.readUrl,idx:0,pgnum:1,os:a.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){f.html("")},success:function(e){a.generateDom(e),n&&c.scrollTop(n)},complete:function(){e&&e()}}))},pullUpLoadData:function(){var e=this;e.readUrl=e.getReadUrl(),e.pgNum=Number(U.get("pgnum_"+e.newsType)),U.set("pgnum_"+e.newsType,++e.pgNum,{exp:86400}),e.idx=Number(U.get("idx_"+e.newsType)),e.idx||(e.idx=0),$.ajax({url:s,data:{type:e.newsType,startkey:U.get("startkey_"+e.newsType),newsnum:"meinv"==e.newsType?10:20,qid:e.qid,readhistory:e.readUrl,idx:e.idx,recgid:e.userId,pgnum:e.pgNum,os:e.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){e.pullUpFlag=!1},success:function(t){e.generateDom(t)},error:function(e,t){console.error(t)},complete:function(){e.pullUpFlag=!0}})},generateDom:function(e){var t=this,a=e&&e.data;if(!a||!a.length)return!1;U.set("startkey_"+t.newsType,e.endkey,{exp:86400});for(var s=a.length,n=0;s>n;n++){var i=a[n],r=i.url,l=i.date,o=i.topic,p=i.source,d=i.miniimg,c=i.recommendtype?i.recommendtype:"-1",u=i.hotnews,m=i.ispicnews,g=i.isadv||"",y=i.adv_id||"",w=i.type,h=i.subtype,v=d.length,_=i.rowkey,T=Number(i.hotnews),x=Number(i.isvideo),k=Number(i.isrecom),b=Number(i.isnxw),j=i.urlpv,$=i.picnums,J=i.praisecnt,S=i.tramplecnt,C="",L="";"1"==g?(L='<i class="promote">推广</i>',C='class="J-promote-news" data-advid="'+y+'"',t.sendAdShowLog(y,r)):T?(L='<i class="hot">热门</i>',x&&(L+='<i class="video">视频</i>')):k?L='<i class="rec">推荐</i>':x?L='<i class="video">视频</i>':b&&(L='<i class="nuanwen">暖文</i>'),r+="meinv"==t.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(t.idx+n+1)+"&recommendtype="+c+"&ishot="+u+"&fr="+t.newsType,"meinv"==t.newsType?f.append('<section class="news-item news-item-s4"><a data-type="'+w+'" data-subtype="'+h+'" href="'+r+'"><div class="news-wrap"><h3>'+o+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+d[0].src+'"></div></div></a><div class="options"><span class="num">'+$+' 图</span><span class="view">'+j+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+_+'">'+J+'</span><span class="J-bad bad" data-rowkey="'+_+'">'+S+"</span></div></section>"):"1"==m?(d=i.lbimg,f.append('<section class="news-item news-item-s3"><a '+C+' data-type="'+w+'" data-subtype="'+h+'" href="'+r+'"><div class="news-wrap"><h3>'+o+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+d[0].src+'"></div><p class="clearfix"><em class="fl">'+(L?L:getSpecialTimeStr(l))+'</em><em class="fr">'+p+"</em></p></div></a></section>")):v>=3?f.append('<section class="news-item news-item-s2"><a '+C+' data-type="'+w+'" data-subtype="'+h+'" href="'+r+'"><div class="news-wrap"><h3>'+o+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+d[0].src+'"></div><div class="img fl"><img class="lazy" src="'+d[1].src+'"></div><div class="img fl"><img class="lazy" src="'+d[2].src+'"></div></div><p class="clearfix"><em class="fl">'+(L?L:getSpecialTimeStr(l))+'</em><em class="fr">'+p+"</em></p></div></a></section>"):f.append('<section class="news-item news-item-s1"><a '+C+' data-type="'+w+'" data-subtype="'+h+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+o+'</h3> <p><em class="fl">'+(L?L:getSpecialTimeStr(l))+'</em><em class="fr">'+p+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+d[0].src+'"></div></div></a></section>')}U.set("idx_"+t.newsType,t.idx+s,{exp:1200}),U.set("news_"+t.newsType,f.html(),{exp:1200})}},new e});