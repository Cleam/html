$(function(){function e(){this.init()}FastClick.attach(document.body);var t="http://minisearch.dfshurufa.com/hotwords/hotwords",a="http://minisearch.dfshurufa.com/search/search02",s=$("#J_search_btn"),r=$("#J_search_input"),c=$("#J_hot_words"),o=$("#J_news_wrap"),n=$("#J_news_list"),i=$("#J_loading"),l=0,h="",d=!0,p=null,f=new WebStorageCache;e.prototype={init:function(){var e=this;f.get("search_hotwords")?c.html(f.get("search_hotwords")):e.loadHotWords(),c.on("click","a",function(){e.clearCaches(),h=$(this).text(),e.loadSearchData(h),r.val(h),e.updateBtnStatus(),e.cacheKw()}),$(window).on("scroll",function(){var t=GLOBAL.Util.getScrollTop(),a=i.offset().top,s=GLOBAL.Util.getClientHeight();a>=s&&t+s>=a&&d&&h?(d=!1,e.loadSearchData(h)):s>a&&i.hide()}),s.on("click",function(t){var a=$(this);a.hasClass("cancel")?(r.val("").focus(),e.clearContent()):(h=$.trim(r.val()),h&&(n.html(""),e.clearCaches(),e.loadSearchData(h),e.cacheKw())),e.updateBtnStatus(),t.preventDefault()}),r.on("keyup",function(t){p&&clearTimeout(p),p=setTimeout(function(){h=$.trim(r.val()),h||(e.clearContent(),e.updateBtnStatus())},300),13===t.keyCode&&(h=$.trim(r.val()),h&&(n.html(""),e.clearCaches(),e.loadSearchData(h),e.cacheKw()),e.updateBtnStatus())}),f.get("search_content")?(c.hide(),o.show(),n.html(f.get("search_content")),e.hideOfShowLoading()):(c.show(),o.hide(),f["delete"]("search_kw")),h=f.get("search_kw"),h&&r.val(h),e.updateBtnStatus()},updateBtnStatus:function(){var e=$.trim(r.val());e?(s.addClass("cancel"),s.text("取消")):(s.removeClass("cancel"),s.text("搜索"))},cacheKw:function(){f.set("search_kw",h)},clearContent:function(){n.empty(),o.hide(),c.show(),f["delete"]("search_content")},clearCaches:function(){f["delete"]("search_param_lastcol"),f["delete"]("search_param_splitwordsarr"),f["delete"]("search_param_stkey")},loadSearchData:function(e){var t=this,s=Cookies.get("qid"),r=Cookies.get("user_id"),n=f.get("search_param_lastcol")?f.get("search_param_lastcol"):"",l=f.get("search_param_splitwordsarr")?JSON.parse(f.get("search_param_splitwordsarr")):"",h=f.get("search_param_stkey")?f.get("search_param_stkey"):"",p=GLOBAL.Util.getPixel();$.ajax({url:a,dataType:"jsonp",timeout:6e3,data:{keywords:encodeURI(e),stkey:encodeURI(h),lastcol:n,splitwordsarr:encodeURI(l),uid:r,qid:s,softtype:"news",softname:"eastday_wapnews",os_type:GLOBAL.Util.getOsType(),browser_type:GLOBAL.Util.getBrowserType(),pixel:p.w+"*"+p.h},jsonp:"jsonpcallback",beforeSend:function(){d=!1,i.show()},success:function(e){try{c.hide(),o.show(),t.generateDom(e)}catch(a){$(".J-no-news").remove(),i.before('<p class="J-no-news" style="text-align: center; font-size: 0.24rem; padding: 30px; color: #999;">抱歉，未找到相关新闻！</p>'),i.hide()}},error:function(){console.error(arguments)},complete:function(){d=!0}})},generateDom:function(e){var t=this,a=e.length;if(l||(l=0),0===a)return $(".J-no-news").remove(),i.before('<p class="J-no-news" style="text-align: center; font-size: 0.24rem; padding: 30px; color: #999;">抱歉，未找到相关新闻！</p>'),void i.hide();for(var s=0;a>s;s++){var r=e[s].url,c=e[s].title,o=e[0].splitword,h=e[s].date,d=e[s].imgstr,p=d.length,m=e[s].source;c=t.getNewStr(c,o),r+="?idx="+l++ +"&fr=search",p>=3?n.append('<section class="news-item news-item-s2"><a href="'+r+'"><div class="news-wrap"><h3>'+c+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+d[0].src+'"></div><div class="img fl"><img class="lazy" src="'+d[1].src+'"></div><div class="img fl"><img class="lazy" src="'+d[2].src+'"></div></div><p class="clearfix"><em class="fl">'+h+'</em><em class="fr">'+m+"</em></p></div></a></section>"):n.append('<section class="news-item news-item-s1"><a href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+c+'</h3> <p><em class="fl">'+h+'</em><em class="fr">'+m+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+d[0].src+'"></div></div></a></section>')}var u=e[0].stkey,w=e[0].lastcol,g=e[0].splitwordsarr;f.set("search_param_stkey",u),f.set("search_param_lastcol",w),f.set("search_param_splitwordsarr",JSON.stringify(g)),f.set("search_content",n.html(),{exp:1200}),t.hideOfShowLoading()},hideOfShowLoading:function(){i.offset().top<GLOBAL.Util.getClientHeight()&&i.hide()},loadHotWords:function(){$.ajax({type:"GET",url:t,dataType:"jsonp",data:{type:"now"},jsonp:"jsonpcallback",timeout:5e3,success:function(e){for(var t=e.ret,a="<h3>热门搜索</h3>",s=0;10>s;s++)a+='<p><a href="javascript:;">'+t[s]+"</a></p>";c.html(a),f.set("search_hotwords",a,{exp:300})},error:function(){console.error(arguments)}})},getNewStr:function(e,t,a){var s=this;if(e&&t&&t.length){var r=t.length;if(t.sort(function(e,t){return t.length-e.length}),a||(a=0),a==r||".."==t[a])return e;var c=new RegExp(t[a],"gi"),o=e,n=o.toLowerCase().indexOf(t[a].toLowerCase()),i=e.substring(n,n+t[a].length);return s.getNewStr(e.replace(c,"<em>"+i+"</em>"),t,++a)}return""}},new e});