$(function(){function e(){this.init()}FastClick.attach(document.body);var t="http://minisearch.dfshurufa.com/hotwords/hotwords",a="http://minisearch.dfshurufa.com/search/search02",s=$("#J_search_btn"),r=$("#J_search_input"),c=$("#J_hot_words"),o=$("#J_news_wrap"),n=$("#J_news_list"),l=$("#J_loading"),i=0,h="",d=!0,p=null,m=new WebStorageCache;e.prototype={init:function(){var e=this;m.get("search_hotwords")?c.html(m.get("search_hotwords")):e.loadHotWords(),c.on("click","a",function(){e.clearCaches(),h=$(this).text(),e.loadSearchData(h),r.val(h),e.updateBtnStatus(),e.cacheKw()}),$(window).on("scroll",function(){var t=getScrollTop(),a=l.offset().top,s=getClientHeight();a>=s&&t+s>=a&&d&&h&&(d=!1,e.loadSearchData(h))}),s.on("click",function(t){var a=$(this);a.hasClass("cancel")?(r.val("").focus(),e.clearContent()):(h=$.trim(r.val()),h&&(n.html(""),e.clearCaches(),e.loadSearchData(h),e.cacheKw())),e.updateBtnStatus(),t.preventDefault()}),r.on("keyup",function(t){p&&clearTimeout(p),p=setTimeout(function(){h=$.trim(r.val()),h||(e.clearContent(),e.updateBtnStatus())},300),13===t.keyCode&&(h=$.trim(r.val()),h&&(n.html(""),e.clearCaches(),e.loadSearchData(h),e.cacheKw()),e.updateBtnStatus())}),m.get("search_content")?(c.hide(),o.show(),n.html(m.get("search_content"))):(c.show(),o.hide(),m["delete"]("search_kw")),h=m.get("search_kw"),h&&r.val(h),e.updateBtnStatus()},updateBtnStatus:function(){var e=$.trim(r.val());e?(s.addClass("cancel"),s.text("取消")):(s.removeClass("cancel"),s.text("搜索"))},cacheKw:function(){m.set("search_kw",h)},clearContent:function(){n.empty(),o.hide(),c.show(),m["delete"]("search_content")},clearCaches:function(){m["delete"]("search_param_lastcol"),m["delete"]("search_param_splitwordsarr"),m["delete"]("search_param_stkey")},loadSearchData:function(e){var t=this,s=Cookies.get("qid"),r=Cookies.get("user_id"),n=m.get("search_param_lastcol")?m.get("search_param_lastcol"):"",i=m.get("search_param_splitwordsarr")?JSON.parse(m.get("search_param_splitwordsarr")):"",h=m.get("search_param_stkey")?m.get("search_param_stkey"):"",p=getPixel();$.ajax({url:a,dataType:"jsonp",timeout:6e3,data:{keywords:encodeURI(e),stkey:encodeURI(h),lastcol:n,splitwordsarr:encodeURI(i),uid:r,qid:s,softtype:"news",softname:"eastday_wapnews",os_type:getOsType(),browser_type:getBrowserType(),pixel:p.w+"*"+p.h},jsonp:"jsonpcallback",beforeSend:function(){d=!1,l.show()},success:function(e){try{c.hide(),o.show(),t.generateDom(e)}catch(a){$(".J-no-news").remove(),l.before('<p class="J-no-news" style="text-align: center; font-size: 0.24rem; padding: 30px; color: #999;">抱歉，未找到相关新闻！</p>'),l.hide()}},error:function(){console.error(arguments)},complete:function(){d=!0}})},generateDom:function(e){var t=this,a=e.length;if(i||(i=0),0===a)return $(".J-no-news").remove(),l.before('<p class="J-no-news" style="text-align: center; font-size: 0.24rem; padding: 30px; color: #999;">抱歉，未找到相关新闻！</p>'),void l.hide();for(var s=0;a>s;s++){var r=e[s].url,c=e[s].title,o=e[0].splitword,h=e[s].date,d=e[s].imgstr,p=d.length,u=e[s].source;c=t.getNewStr(c,o),r+="?idx="+i++,p>=3?n.append('<section class="news-item news-item-s2"><a href="'+r+'"><div class="news-wrap"><h3>'+c+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+d[0].src+'"></div><div class="img fl"><img class="lazy" src="'+d[1].src+'"></div><div class="img fl"><img class="lazy" src="'+d[2].src+'"></div></div><p class="clearfix"><em class="fl">'+h+'</em><em class="fr">'+u+"</em></p></div></a></section>"):n.append('<section class="news-item news-item-s1"><a href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+c+'</h3> <p><em class="fl">'+h+'</em><em class="fr">'+u+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+d[0].src+'"></div></div></a></section>')}var w=e[0].stkey,f=e[0].lastcol,g=e[0].splitwordsarr;m.set("search_param_stkey",w),m.set("search_param_lastcol",f),m.set("search_param_splitwordsarr",JSON.stringify(g)),m.set("search_content",n.html(),{exp:1200})},loadHotWords:function(){$.ajax({type:"GET",url:t,dataType:"jsonp",data:{type:"now"},jsonp:"jsonpcallback",timeout:5e3,success:function(e){for(var t=e.ret,a="<h3>热门搜索</h3>",s=0;10>s;s++)a+='<p><a href="javascript:;">'+t[s]+"</a></p>";c.html(a),m.set("search_hotwords",a,{exp:300})},error:function(){console.error(arguments)}})},getNewStr:function(e,t,a){var s=this;if(e&&t&&t.length){var r=t.length;if(t.sort(function(e,t){return t.length-e.length}),a||(a=0),a==r)return e;var c=new RegExp(t[a],"gi"),o=e,n=o.toLowerCase().indexOf(t[a].toLowerCase()),l=e.substring(n,n+t[a].length);return s.getNewStr(e.replace(c,"<em>"+l+"</em>"),t,++a)}return""}},new e});