$(function(){function e(){var e=U.get("current_newstype");this.newsType=e?e:"toutiao",this.readUrl="",this.userId="",this.idx=0,this.pgNum=1,this.pulldown_pgNum=0,this.pulldown_idx=0,this.pulldown_num=0,this.qid=getQueryString("qid"),this.pullUpFlag=!0,this.startKey="",this.endKey="",this.osType=getOsType(),this.browserType=getBrowserType(),this.init()}FastClick.attach(document.body);var a="http://toutiao.eastday.com/toutiao_h5/RefreshJP",t="http://toutiao.eastday.com/toutiao_h5/pulldown",s="http://toutiao.eastday.com/toutiao_h5/NextJP",n="http://position.dfshurufa.com/position/get",i="http://toutiao.eastday.com/getwapdata/getuid",r="http://toutiao.eastday.com/pjson/zan",o="http://123.59.60.170/getwapdata/data",l="http://123.59.60.170/online/online",p="http://123.59.60.170/getwapdata/advshow",d="http://123.59.60.170/getwapdata/ad",c=$("body"),u=[],m=[],f=$("#J_news_list"),g=$("#J_refresh"),w=$("#J_top_menu"),h=!0,y=0,v=0,_=!0,T=!1,x=!1,k=null,b=200,j=null,U=new WebStorageCache;e.prototype={init:function(){function e(e,t,s){var n=e.data("rowkey"),i=a.getPraiseTrampleStatus(n);return 1===i?void alert("您已经赞过了！"):-1===i?void alert("您已经踩过了！"):void(h&&(h=!1,e.addClass("active").text(Number(e.text())+1),$.ajax({url:r,dataType:"jsonp",data:{colname:t,rowkey:n,praisecnt:1},jsonp:"jsonpcallback",success:function(e){a.cachePraiseTrampleRowkey(s,n),h=!0},error:function(e){console.error(e)}})))}var a=this;a.qid?a.setQid(a.qid):Cookies.remove("qid",{path:""}),a.userId=a.getUid(),a.userId||a.setUid(),a.readUrl=U.get("read_url_all"),a.readUrl||(a.readUrl=""),a.initChannels(function(){var e=w.children("a");e.each(function(){var e=$(this),a=e.data("type");u.push(a),"meinv"!==a&&"nuanwen"!==a&&m.push(a)}),e.each(function(){var e=$(this);return e.data("type")==a.newsType?(a.scrollTo(e),!1):void 0}),U.get("location")?a.updateDomLocation(U.get("location")):a.location()}),a.refreshData(function(){a.highlightPraiseTrample()}),a.pullDown(),w.on("click","a",function(){var e=$(this),t=e.data("type");a.scrollTo(e),U.set("prev_newstype",a.newsType,{exp:1200}),U.set("current_newstype",t,{exp:1200}),a.newsType=t,a.refreshData(function(){a.highlightPraiseTrample()}),a.addLog()}),$(window).on("scroll",function(){var e=getScrollTop(),t=$("#J_loading").offset().top,s=getClientHeight(),n=null;n&&clearTimeout(n),n=setTimeout(function(){U.set("news_pos_"+a.newsType,e,{exp:1200})},200),t>=s&&e+s>=t&&a.pullUpFlag&&a.pullUpLoadData()}),g.on("click",function(){g.hasClass("active")||(a.changeRefreshStatus(),U["delete"]("news_pos_"+a.newsType),U["delete"]("news_"+a.newsType),a.refreshData(function(){a.highlightPraiseTrample()}))}),f.on("click","a",function(e){var t=$(this),s=t.attr("href");s=s.substring(s.indexOf("/mobile/")+8,s.indexOf(".html")),a.cacheReadUrl(s,t.data("type"),t.data("subtype"))}),c.on("click",".J-read-position",function(){c.scrollTop(0),c.find(".J-read-position").remove(),a.changeRefreshStatus(),a.pullDownLoadData()}),c.on("click",".J-promote-news",function(){var e=$(this),t=e.attr("href"),s=e.data("advid");a.sendPromoteNewslog(t,s)}),f.on("click",".J-good",function(){e($(this),"z0000",1)}),f.on("click",".J-bad",function(){e($(this),"zd0000",-1)}),a.addOnlineLog(),setInterval(function(){a.addOnlineLog()},1e4)},changeRefreshStatus:function(){g.addClass("active"),setTimeout(function(){g.removeClass("active")},700)},initChannels:function(e){var a=this,t=U.get("news_channels");t?(a.generateChannelTabs(t),e&&e()):$.ajax({url:"data/channels.json",dataType:"json",success:function(t){a.generateChannelTabs(t.channels.up),e&&e()},error:function(){console.error(arguments)}})},sendPromoteNewslog:function(e,a){var t=this,s=getPixel();$.ajax({url:d,dataType:"jsonp",data:{qid:t.qid,uid:t.userId,loginid:"null",softtype:"news",softname:"eastday_wapnews",newstype:"ad",from:"null",to:e,os_type:getOsType(),browser_type:getBrowserType(),pixel:s.w+"*"+s.h,ime:"null",refer:getReferrer(),adv:a},jsonp:"jsonpcallback",success:function(e){}})},generateChannelTabs:function(e){if(e&&e instanceof Array){for(var a="",t=0;t<e.length;t++)a+=0===t?'<a class="active" data-type="'+e[t].name+'">'+e[t].value+"</a>":'<a data-type="'+e[t].name+'">'+e[t].value+"</a>";w.html(a),U.set("news_channels",e)}},getMyChannels:function(e,a){if(!e||!a)return[];for(var t=new Array,s=a.length,n=e.length,i=0;s>i;i++)for(var r=0;n>r;r++)a[i].name==e[r].name&&t.push(a[i]);return t},pullDown:function(){var e=this,a=0;f.on("touchstart",function(e){clearTimeout(j),y=e.touches[0].pageY,x=c.scrollTop()<=0,k?k.removeClass("active").css({display:"block",opacity:0,top:a,transform:"translateY(0px)","-webkit-transform":"translateY(0px)"}):(a=$("header").height()-40,k=$('<svg id="J_svg" class="svg" style="top: '+a+'px"><g id="J_svg_g"><marker id="J_svg_marker" markerWidth="10" markerHeight="10" refX="0" refY="5" orient="auto" markerUnits="userSpaceOnUse"><path d="M0,0 L0,10 L5,5 L0,0" style="fill: #d43d3d;"></path></marker><path stroke-width="3.5" stroke-linecap="round" id="J_svg_path" marker-end="url(#J_svg_marker)" d="M20,9 A11,11 0 1,1 10.5,14.5" style="stroke: #d43d3d; fill: none;"></path><circle id="J_svg_circle" class="path" fill="none" stroke-width="3.5" stroke-linecap="round" cx="25" cy="25" r="11"></circle></g></svg>'))}),f.on("touchend",function(){v===b?(k&&k.addClass("active"),clearTimeout(j),j=setTimeout(function(){"meinv"==e.newsType?(g.trigger("click"),k&&k.remove()):e.pullDownLoadData(function(){k&&k.remove()})},400)):k&&k.animate({opacity:0,top:a},"fast",function(){k.remove()}),_=!0,T=!1}),f.on("touchmove",function(e){var t=e.touches[0].pageY;v=t-y,_&&v>0&&(T=!0,_=!1),x&&T&&(0===c.find(".svg").length&&k.appendTo("body"),v>=b?(k.find("#J_svg_marker>path").attr("style","fill:#2a90d7"),k.find("#J_svg_g>path").attr("style","stroke:#2a90d7;fill:none"),v=b):(k.find("#J_svg_marker>path").attr("style","fill:#d43d3d"),k.find("#J_svg_g>path").attr("style","stroke:#d43d3d;fill:none")),k.css({opacity:v/b,transform:"rotate("+v/b*360+"deg)","-webkit-transform":"rotate("+v/b*360+"deg)",top:a+v/3+"px"}),e.preventDefault())})},pullDownLoadData:function(e){var a=this;a.readUrl=a.getReadUrl(),a.pulldown_pgNum=Number(U.get("pulldown_pgnum_"+a.newsType)),U.set("pulldown_pgnum_"+a.newsType,--a.pulldown_pgNum,{exp:86400}),a.pulldown_idx=Number(U.get("pulldown_idx_"+a.newsType)),a.pulldown_idx||(a.pulldown_idx=0),$.ajax({url:t,data:{type:a.newsType,startkey:U.get("startkey_"+a.newsType),lastkey:U.get("endkey_"+a.newsType),pgnum:a.pulldown_pgNum,idx:a.pulldown_idx,readhistory:a.readUrl,recgid:a.userId,qid:a.qid,os:a.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){},success:function(e){a.generateDomForPulldown(e)},error:function(e){console.error(e)},complete:function(){e&&e()}})},getReadUrl:function(){var e=this,a="";return a="toutiao"==e.newsType||"weikandian"==e.newsType?U.get("read_url_all"):U.get("read_url_"+e.newsType),a?a:null},generateDomForPulldown:function(e){var a=this,t=e&&e.data,s=t.length;if(!t||!t.length)return!1;a.pulldown_num++,U.set("startkey_"+a.newsType,e.endkey,{exp:86400}),U.set("endkey_"+a.newsType,e.newkey,{exp:86400}),t.reverse(),f.prepend('<a class="J-read-position read-position">上次浏览到这里，点击刷新。</a>');for(var n=0;s>n;n++){var i=t[n],r=i.url,o=i.date,l=i.topic,p=i.source,d=i.miniimg,c=i.recommendtype?i.recommendtype:"-1",u=i.hotnews,m=i.ispicnews,g=i.isadv||"",w=i.adv_id||"",h=i.type,y=i.subtype,v=d.length,_=(i.rowkey,Number(i.hotnews)),T=Number(i.isvideo),x=Number(i.isrecom),k=Number(i.isnxw),b=(i.urlpv,i.picnums,i.praisecnt,i.tramplecnt,""),j="";"1"==g?(j='<i class="promote">推广</i>',b='class="J-promote-news" data-advid="'+w+'"',a.sendAdShowLog(w,r)):_?(j='<i class="hot">热门</i>',T&&(j+='<i class="video">视频</i>')):x?j='<i class="rec">推荐</i>':T?j='<i class="video">视频</i>':k&&(j='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.pulldown_idx-n-1)+"&recommendtype="+c+"&ishot="+u+"&fr="+a.newsType,"1"==m?(d=i.lbimg,f.prepend('<section class="news-item news-item-s3"><a '+b+' data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+d[0].src+'" alt="'+d[0].alt+'"></div><p class="clearfix"><em class="fl">'+(j?j:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>")):v>=3?f.prepend('<section class="news-item news-item-s2"><a '+b+' data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+d[0].src+'" alt="'+d[0].alt+'"></div><div class="img fl"><img class="lazy" src="'+d[1].src+'" alt="'+d[1].alt+'"></div><div class="img fl"><img class="lazy" src="'+d[2].src+'" alt="'+d[2].alt+'"></div></div><p class="clearfix"><em class="fl">'+(j?j:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>"):f.prepend('<section class="news-item news-item-s1"><a '+b+' data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(j?j:getSpecialTimeStr(o))+'</em><em class="fr">'+p+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+d[0].src+'" alt="'+d[0].alt+'"></div></div></a></section>')}var J=$('<p id="J_recommend_news" class="recommend-news">为您推荐<span>'+s+"</span>条新闻</p>");if(J.appendTo("body"),setTimeout(function(){J.fadeOut("slow",function(){J.remove()})},1e3),a.pulldown_num>=20){a.pulldown_num=0;for(var S=f.children(),C=S.length,n=C-1;n>=C-20;n--)S[n].remove()}U.set("pulldown_idx_"+a.newsType,a.pulldown_idx-s,{exp:1200}),U.set("news_"+a.newsType,f.html(),{exp:1200})},sendAdShowLog:function(e,a){var t=this,s=getPixel();$.ajax({url:p,dataType:"jsonp",data:{qid:t.qid,uid:t.userId,loginid:"null",softtype:"news",softname:"eastday_wapnews",newstype:"ad",from:"null",advurl:a,os_type:getOsType(),browser_type:getBrowserType(),fr_url:"null",pixel:s.w+"*"+s.h,ime:"null",adv:e},jsonp:"jsonpcallback",success:function(e){}})},highlightPraiseTrample:function(){var e=this;"meinv"==e.newsType&&(f.find(".J-good").each(function(){var a=$(this);1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}),f.find(".J-bad").each(function(){var a=$(this);-1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}))},getPraiseTrampleStatus:function(e){var a=U.get("praise_rowkey"),t=U.get("trample_rowkey");return a&&-1!=a.indexOf(e)?1:t&&-1!=t.indexOf(e)?-1:0},cachePraiseTrampleRowkey:function(e,a){var t=U.get("praise_trample_rowkey"),s=U.get("praise_rowkey"),n=U.get("trample_rowkey");t?t+=","+a:t=a,U.set("praise_trample_rowkey",t,{exp:31536e3}),1===e?(s?s+=","+a:s=a,U.set("praise_rowkey",s,{exp:31536e3})):(n?n+=","+a:n=a,U.set("trample_rowkey",n,{exp:31536e3}))},location:function(){var e=this;$.ajax({url:n,dataType:"jsonp",jsonp:"jsonpcallback",success:function(a){try{var t=a.position,s=e.getCityPinyin(t.provname),n=null;s&&(n={prov_id:t.pro_id,prov_py:s,prov_name:t.provname},e.updateDomLocation(n),U.set("location",n,{exp:2592e3}))}catch(i){console.error(i)}},error:function(e,a){console.error(a)}})},updateDomLocation:function(e){w.children("a").eq(1).after('<a data-type="'+e.prov_py+'">'+e.prov_name+"</a>")},getCityPinyin:function(e){switch(e){case"上海":return"shanghai";case"北京":return"beijing";case"河南":return"henan";case"广东":return"guangdong";default:return null}},cacheReadUrl:function(e,a,t){var s=this;if(!s.existReadUrl(e)&&m.contains(a)){var n=U.get("read_url_all");if(n){for(n=n.split(",");n.length>=5;)n.shift();n.push(e),s.readUrl=n.join(",")}else s.readUrl=e;U.set("read_url_all",s.readUrl,{exp:31536e3});var i=U.get("read_url_"+a);if(i){for(i=i.split(",");i.length>=3;)i.shift();i.push(e),i=i.join(",")}else i=e;if(U.set("read_url_"+a,i,{exp:31536e3}),t){var r=U.get("read_url_"+t);if(r){for(r=r.split(",");r.length>=3;)r.shift();r.push(e),r=r.join(",")}else r=e;U.set("read_url_"+t,r,{exp:31536e3})}}},existReadUrl:function(e){var a=U.get("read_url_all");return!(!a||-1===a.indexOf(e))},clearPosition:function(e){U["delete"]("news_pos_"+e)},scrollTo:function(e){var a=w.children("a");a.removeClass("active"),e.addClass("active"),w.scrollLeft(e[0].offsetLeft-3*a.eq(0).width())},setQid:function(e){e&&Cookies.set("qid",e,{expires:365,path:"/",domain:"eastday.com"})},getQid:function(){var e=Cookies.get("qid");return e?e:""},setUid:function(){var e=this;$.ajax({url:i,dataType:"jsonp",data:{softtype:"news",softname:"eastday_wapnews"},jsonp:"jsonpcallback",success:function(a){try{e.userId=a.uid,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})}catch(t){console.error(t)}},error:function(e){console.error(e)}})},getUid:function(){var e=Cookies.get("user_id");return e?e:""},addLog:function(){var e=getPixel(),a=this;$.ajax({url:o,data:{qid:a.qid,uid:a.userId,softtype:"news",softname:"eastday_wapnews",newstype:a.newsType,from:U.get("prev_newstype"),to:U.get("current_newstype"),os_type:getOsType(),browser_type:getBrowserType(),pixel:e.w+"*"+e.h,fr_url:getReferrer(),loginid:"null",ime:"",idx:"",ishot:"",ver:"",appqid:"",ttloginid:"",apptypeid:"",appver:"",recommendtype:"",ispush:""},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},addOnlineLog:function(){var e=this,a=getUrlNoParams()+"	"+e.userId+"	"+e.qid+"	null	null	null	"+e.newsType+"	null	null	"+getOsType()+"	null";$.ajax({url:l,data:{param:encodeURI(a)},dataType:"jsonp",jsonp:"jsonpcallback"})},refreshData:function(e){var t=this,s=U.get("news_"+t.newsType),n=U.get("news_pos_"+t.newsType);s?(f.html(s),n&&c.scrollTop(n)):(U["delete"]("pulldown_idx_"+t.newsType),U.set("pgnum_"+t.newsType,1,{exp:1200}),t.readUrl=t.getReadUrl(),$.ajax({url:a,data:{type:t.newsType,recgid:t.userId,qid:t.qid,picnewsnum:1,readhistory:t.readUrl,idx:0,pgnum:1,os:t.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){f.html("")},success:function(e){t.generateDom(e),n&&c.scrollTop(n)},complete:function(){e&&e()}}))},pullUpLoadData:function(){var e=this;e.readUrl=e.getReadUrl(),e.pgNum=Number(U.get("pgnum_"+e.newsType)),U.set("pgnum_"+e.newsType,++e.pgNum,{exp:86400}),e.idx=Number(U.get("idx_"+e.newsType)),e.idx||(e.idx=0),$.ajax({url:s,data:{type:e.newsType,startkey:U.get("startkey_"+e.newsType),newsnum:"meinv"==e.newsType?10:20,qid:e.qid,readhistory:e.readUrl,idx:e.idx,recgid:e.userId,pgnum:e.pgNum,os:e.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){e.pullUpFlag=!1},success:function(a){e.generateDom(a)},error:function(e,a){console.error(a)},complete:function(){e.pullUpFlag=!0}})},generateDom:function(e){var a=this,t=e&&e.data;if(!t||!t.length)return!1;U.set("startkey_"+a.newsType,e.endkey,{exp:86400});for(var s=t.length,n=0;s>n;n++){var i=t[n],r=i.url,o=i.date,l=i.topic,p=i.source,d=i.miniimg,c=i.recommendtype?i.recommendtype:"-1",u=i.hotnews,m=i.ispicnews,g=i.isadv||"",w=i.adv_id||"",h=i.type,y=i.subtype,v=d.length,_=i.rowkey,T=Number(i.hotnews),x=Number(i.isvideo),k=Number(i.isrecom),b=Number(i.isnxw),j=i.urlpv,$=i.picnums,J=i.praisecnt,S=i.tramplecnt,C="",N="";"1"==g?(N='<i class="promote">推广</i>',C='class="J-promote-news" data-advid="'+w+'"',a.sendAdShowLog(w,r)):T?(N='<i class="hot">热门</i>',x&&(N+='<i class="video">视频</i>')):k?N='<i class="rec">推荐</i>':x?N='<i class="video">视频</i>':b&&(N='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.idx+n+1)+"&recommendtype="+c+"&ishot="+u+"&fr="+a.newsType,"meinv"==a.newsType?f.append('<section class="news-item news-item-s4"><a data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+d[0].src+'"></div></div></a><div class="options"><span class="num">'+$+' 图</span><span class="view">'+j+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+_+'">'+J+'</span><span class="J-bad bad" data-rowkey="'+_+'">'+S+"</span></div></section>"):"1"==m?(d=i.lbimg,f.append('<section class="news-item news-item-s3"><a '+C+' data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+d[0].src+'"></div><p class="clearfix"><em class="fl">'+(N?N:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>")):v>=3?f.append('<section class="news-item news-item-s2"><a '+C+' data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+d[0].src+'"></div><div class="img fl"><img class="lazy" src="'+d[1].src+'"></div><div class="img fl"><img class="lazy" src="'+d[2].src+'"></div></div><p class="clearfix"><em class="fl">'+(N?N:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>"):f.append('<section class="news-item news-item-s1"><a '+C+' data-type="'+h+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(N?N:getSpecialTimeStr(o))+'</em><em class="fr">'+p+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+d[0].src+'"></div></div></a></section>')}U.set("idx_"+a.newsType,a.idx+s,{exp:1200}),U.set("news_"+a.newsType,f.html(),{exp:1200})}},new e});