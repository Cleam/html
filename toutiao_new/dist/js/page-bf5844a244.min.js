$(function(){function e(){var e=b.get("current_newstype");this.newsType=e?e:"toutiao",this.readUrl="",this.userId="",this.idx=0,this.pgNum=1,this.pulldown_pgNum=0,this.pulldown_idx=0,this.pulldown_num=0,this.qid=getQueryString("qid"),this.pullUpFlag=!0,this.osType=getOsType(),this.browserType=getBrowserType(),this.init()}FastClick.attach(document.body);var a="http://toutiao.eastday.com/toutiao_h5/RefreshJP",s="http://toutiao.eastday.com/toutiao_h5/pulldown",t="http://toutiao.eastday.com/toutiao_h5/NextJP",n="http://position.dfshurufa.com/position/get",i="http://toutiao.eastday.com/getwapdata/getuid",r="http://toutiao.eastday.com/pjson/zan",o="http://toutiao.eastday.com/getwapdata/data",l="http://ot.dftoutiao.com/apponline/online",c=[],p=[],d=$("#J_news_list"),u=$("#J_refresh"),m=$("#J_top_menu"),w=!0,f=0,y=0,g=!0,h=!1,v=!1,_=null,T=200,x=null,b=new WebStorageCache;e.prototype={init:function(){function e(e,s,t){var n=e.data("rowkey"),i=a.getPraiseTrampleStatus(n);return 1===i?void alert("您已经赞过了！"):-1===i?void alert("您已经踩过了！"):void(w&&(w=!1,e.addClass("active").text(Number(e.text())+1),$.ajax({url:r,dataType:"jsonp",data:{colname:s,rowkey:n,praisecnt:1},jsonp:"jsonpcallback",success:function(e){a.cachePraiseTrampleRowkey(t,n),w=!0},error:function(e){console.error(e)}})))}var a=this;a.qid?a.setQid(a.qid):Cookies.remove("qid",{path:""}),a.userId=a.getUid(),a.userId||a.setUid(),a.readUrl=b.get("read_url_all"),a.readUrl||(a.readUrl=""),a.initChannels(function(){var e=m.children("a");e.each(function(){var e=$(this),a=e.data("type");c.push(a),"meinv"!==a&&"nuanwen"!==a&&p.push(a)}),e.each(function(){var e=$(this);return e.data("type")==a.newsType?(a.scrollTo(e),!1):void 0}),b.get("location")?a.updateDomLocation(b.get("location")):a.location()}),a.refreshData(function(){a.highlightPraiseTrample()}),a.pullDown(),m.on("click","a",function(){var e=$(this),s=e.data("type");a.scrollTo(e),b.set("prev_newstype",a.newsType,{exp:1200}),b.set("current_newstype",s,{exp:1200}),a.newsType=s,a.refreshData(function(){a.highlightPraiseTrample()}),a.addLog()}),$(window).on("scroll",function(){var e=getScrollTop(),s=$("#J_loading").offset().top,t=getClientHeight(),n=null;n&&clearTimeout(n),n=setTimeout(function(){b.set("news_pos_"+a.newsType,e,{exp:1200})},200),e+t>=s&&a.pullUpFlag&&a.pullUpLoadData()}),u.on("click",function(){u.hasClass("active")||(u.addClass("active"),setTimeout(function(){u.removeClass("active")},700),b["delete"]("news_pos_"+a.newsType),b["delete"]("news_"+a.newsType),a.refreshData(function(){a.highlightPraiseTrample()}))}),d.on("click","a",function(e){var s=$(this),t=s.attr("href");t=t.substring(t.indexOf("/mobile/")+8,t.indexOf(".html")),a.cacheReadUrl(t,s.data("type"),s.data("subtype"))}),d.on("click",".J-good",function(){e($(this),"z0000",1)}),d.on("click",".J-bad",function(){e($(this),"zd0000",-1)}),setInterval(function(){},1e4)},initChannels:function(e){var a=this,s=b.get("news_channels");s?(a.generateChannelTabs(s),e&&e()):$.ajax({url:"data/channels.json",dataType:"json",success:function(s){a.generateChannelTabs(s.channels.up),e&&e()},error:function(){console.error(arguments)}})},generateChannelTabs:function(e){if(e&&e instanceof Array){for(var a="",s=0;s<e.length;s++)a+=0===s?'<a class="active" data-type="'+e[s].name+'">'+e[s].value+"</a>":'<a data-type="'+e[s].name+'">'+e[s].value+"</a>";m.html(a),b.set("news_channels",e)}},getMyChannels:function(e,a){if(!e||!a)return[];for(var s=new Array,t=a.length,n=e.length,i=0;t>i;i++)for(var r=0;n>r;r++)a[i].name==e[r].name&&s.push(a[i]);return s},pullDown:function(){var e=this;d.on("touchstart",function(e){clearTimeout(x),f=e.touches[0].pageY,v=$("body").scrollTop()<=0,_?_.removeClass("active").css({display:"block",opacity:0,transform:"scale(0.2) translateY(0px)","-webkit-transform":"scale(0.2) translateY(0px)"}):_=$('<div class="pulldown-loading"><div class="spinner"><div class="bounce bounce1"></div> <div class="bounce bounce2"></div> <div class="bounce bounce3"></div></div></div>')}),d.on("touchend",function(){y===T?(_&&_.addClass("active"),clearTimeout(x),x=setTimeout(function(){e.pullDownLoadData()},400)):_&&_.animate({opacity:0,scale:"0.2",translateY:"0"},"fast",function(){_.remove()}),g=!0,h=!1}),d.on("touchmove",function(e){var a=e.touches[0].pageY;y=a-f,g&&y>0&&(h=!0,g=!1),v&&h&&(0===$("body").find(".pulldown-loading").length&&_.appendTo("body"),y>=T?(_.find(".bounce").css("backgroundColor","#2a90d7"),y=T):_.find(".bounce").css("backgroundColor","#d43d3d"),_.css({opacity:y/T,transform:"scale("+(.8*y/T+.2)+") translateY("+y/6+"px)","-webkit-transform":"scale("+(.8*y/T+.2)+") translateY("+y/6+"px)"}),e.preventDefault())})},pullDownLoadData:function(e){var a=this;a.readUrl=a.getReadUrl(),a.pulldown_pgNum=Number(b.get("pulldown_pgnum_"+a.newsType)),b.set("pulldown_pgnum_"+a.newsType,--a.pulldown_pgNum,{exp:86400}),a.pulldown_idx=Number(b.get("pulldown_idx_"+a.newsType)),a.pulldown_idx||(a.pulldown_idx=0),$.ajax({url:s,data:{type:a.newsType,startkey:b.get("pulldown_startkey_"+a.newsType),lastkey:b.get("pulldown_lastkey_"+a.newsType),pgnum:a.pulldown_pgNum,idx:a.pulldown_idx,readhistory:a.readUrl,recgid:a.userId,qid:a.qid,os:a.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){},success:function(e){a.generateDomForPulldown(e)},error:function(e){console.error(e)},complete:function(){_&&_.remove(),e&&e()}})},getReadUrl:function(){var e=this,a="";return a="toutiao"==e.newsType||"weikandian"==e.newsType?b.get("read_url_all"):b.get("read_url_"+e.newsType),a?a:null},generateDomForPulldown:function(e){var a=this,s=e&&e.data;if(!s||!s.length)return!1;a.pulldown_num++,b.set("pulldown_startkey_"+a.newsType,e.endkey,{exp:86400}),b.set("pulldown_lastkey_"+a.newsType,e.newkey,{exp:86400});var t=s.length;s.reverse();for(var n=0;t>n;n++){var i=s[n],r=i.url,o=i.date,l=i.topic,c=i.source,p=i.miniimg,u=i.recommendtype?i.recommendtype:"-1",m=i.hotnews,w=i.ispicnews,f=i.type,y=i.subtype,g=p.length,h=i.rowkey,v=Number(i.hotnews),_=Number(i.isvideo),T=Number(i.isrecom),x=Number(i.isnxw),k=i.urlpv,j=i.picnums,U=i.praisecnt,C=i.tramplecnt,N="";v?(N='<i class="hot">热门</i>',_&&(N+='<i class="video">视频</i>')):T?N='<i class="rec">推荐</i>':_?N='<i class="video">视频</i>':x&&(N='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.pulldown_idx-n-1)+"&recommendtype="+u+"&ishot="+m+"&fr="+a.newsType,"meinv"==a.newsType?d.prepend('<section class="news-item news-item-s4"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'" alt="'+p[0].alt+'"></div></div></a><div class="options"><span class="num">'+j+' 图</span><span class="view">'+k+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+h+'">'+U+'</span><span class="J-bad bad" data-rowkey="'+h+'">'+C+"</span></div></section>"):"1"==w?d.prepend('<section class="news-item news-item-s3"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'" alt="'+p[0].alt+'"></div><p class="clearfix"><em class="fl">'+(N?N:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>"):g>=3?d.prepend('<section class="news-item news-item-s2"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+p[0].src+'" alt="'+p[0].alt+'"></div><div class="img fl"><img class="lazy" src="'+p[1].src+'" alt="'+p[1].alt+'"></div><div class="img fl"><img class="lazy" src="'+p[2].src+'" alt="'+p[2].alt+'"></div></div><p class="clearfix"><em class="fl">'+(N?N:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>"):d.prepend('<section class="news-item news-item-s1"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(N?N:getSpecialTimeStr(o))+'</em><em class="fr">'+c+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+p[0].src+'" alt="'+p[0].alt+'"></div></div></a></section>')}var S=$('<p id="J_recommend_news" class="recommend-news">为您推荐<span>'+t+"</span>条新闻</p>");if(S.appendTo("body"),setTimeout(function(){S.fadeOut("slow",function(){S.remove()})},600),a.pulldown_num>=20){a.pulldown_num=0;for(var D=d.children(),t=D.length,n=t-1;n>=t-20;n--)D[n].remove()}b.set("pulldown_idx_"+a.newsType,a.pulldown_idx-t,{exp:1200}),b.set("news_"+a.newsType,d.html(),{exp:1200})},highlightPraiseTrample:function(){var e=this;"meinv"==e.newsType&&(d.find(".J-good").each(function(){var a=$(this);1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}),d.find(".J-bad").each(function(){var a=$(this);-1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}))},getPraiseTrampleStatus:function(e){var a=b.get("praise_rowkey"),s=b.get("trample_rowkey");return a&&-1!=a.indexOf(e)?1:s&&-1!=s.indexOf(e)?-1:0},cachePraiseTrampleRowkey:function(e,a){var s=b.get("praise_trample_rowkey"),t=b.get("praise_rowkey"),n=b.get("trample_rowkey");s?s+=","+a:s=a,b.set("praise_trample_rowkey",s,{exp:31536e3}),1===e?(t?t+=","+a:t=a,b.set("praise_rowkey",t,{exp:31536e3})):(n?n+=","+a:n=a,b.set("trample_rowkey",n,{exp:31536e3}))},location:function(){var e=this;$.ajax({url:n,dataType:"jsonp",jsonp:"jsonpcallback",success:function(a){try{var s=a.position,t=e.getCityPinyin(s.provname),n=null;t&&(n={prov_id:s.pro_id,prov_py:t,prov_name:s.provname},e.updateDomLocation(n),b.set("location",n,{exp:2592e3}))}catch(i){console.error(i)}},error:function(e,a){console.error(a)}})},updateDomLocation:function(e){m.children("a").eq(1).after('<a data-type="'+e.prov_py+'">'+e.prov_name+"</a>")},getCityPinyin:function(e){switch(e){case"上海":return"shanghai";case"北京":return"beijing";case"河南":return"henan";case"广东":return"guangdong";default:return null}},cacheReadUrl:function(e,a,s){var t=this;if(!t.existReadUrl(e)&&p.contains(a)){var n=b.get("read_url_all");if(n){for(n=n.split(",");n.length>=5;)n.shift();n.push(e),t.readUrl=n.join(",")}else t.readUrl=e;b.set("read_url_all",t.readUrl,{exp:1200});var i=b.get("read_url_"+a);if(i){for(i=i.split(",");i.length>=3;)i.shift();i.push(e),i=i.join(",")}else i=e;if(b.set("read_url_"+a,i,{exp:1200}),s){var r=b.get("read_url_"+s);if(r){for(r=r.split(",");r.length>=3;)r.shift();r.push(e),r=r.join(",")}else r=e;b.set("read_url_"+s,r,{exp:1200})}}},existReadUrl:function(e){var a=b.get("read_url_all");return!(!a||-1===a.indexOf(e))},clearPosition:function(e){b["delete"]("news_pos_"+e)},scrollTo:function(e){var a=m.children("a");a.removeClass("active"),e.addClass("active"),m.scrollLeft(e[0].offsetLeft-3*a.eq(0).width())},setQid:function(e){e&&Cookies.set("qid",e,{expires:365,path:"/",domain:"eastday.com"})},getQid:function(){var e=Cookies.get("qid");return e?e:""},setUid:function(){var e=this;$.ajax({url:i,dataType:"jsonp",data:{softtype:"news",softname:"eastday_wapnews"},jsonp:"jsonpcallback",success:function(a){try{e.userId=a.uid,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})}catch(s){console.error(s)}},error:function(e){console.error(e)}})},getUid:function(){var e=Cookies.get("user_id");return e?e:""},addLog:function(){var e=getPixel(),a=this;$.ajax({url:o,data:{qid:a.qid,uid:a.userId,softtype:"news",softname:"eastday_wapnews",newstype:a.newsType,from:b.get("prev_newstype"),to:b.get("current_newstype"),os_type:getOsType(),browser_type:getBrowserType(),pixel:e.w+"*"+e.h,fr_url:getReferrer(),loginid:"null",ime:"",idx:"",ishot:"",ver:"",appqid:"",ttloginid:"",apptypeid:"",appver:"",recommendtype:"",ispush:""},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},addOnlineLog:function(){var e=this,a=getUrlNoParams()+"	"+e.userId+"	"+e.qid+"	null	null	null	"+e.newsType+"	null	null	"+getOsType()+"	null";$.ajax({url:l,data:{param:encodeURI(a)},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},refreshData:function(e){var s=this,t=b.get("news_"+s.newsType),n=b.get("news_pos_"+s.newsType);t?(d.html(t),n&&$("body").scrollTop(n)):(b["delete"]("pulldown_idx_"+s.newsType),b.set("pgnum_"+s.newsType,1,{exp:1200}),s.readUrl=s.getReadUrl(),$.ajax({url:a,data:{type:s.newsType,recgid:s.userId,qid:s.qid,picnewsnum:1,readhistory:s.readUrl,idx:0,pgnum:1,os:s.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){d.html("")},success:function(e){s.generateDom(e),n&&$("body").scrollTop(n)},complete:function(){e&&e()}}))},pullUpLoadData:function(){var e=this;e.readUrl=e.getReadUrl(),e.pgNum=Number(b.get("pgnum_"+e.newsType)),b.set("pgnum_"+e.newsType,++e.pgNum,{exp:86400}),e.idx=Number(b.get("idx_"+e.newsType)),e.idx||(e.idx=0),$.ajax({url:t,data:{type:e.newsType,startkey:b.get("rowkey_"+e.newsType),newsnum:"meinv"==e.newsType?10:20,qid:e.qid,readhistory:e.readUrl,idx:e.idx,recgid:e.userId,pgnum:e.pgNum,os:e.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){e.pullUpFlag=!1},success:function(a){e.generateDom(a)},error:function(e,a){console.error(a)},complete:function(){e.pullUpFlag=!0}})},generateDom:function(e){var a=this,s=e&&e.data;if(!s||!s.length)return!1;b.set("rowkey_"+a.newsType,e.endkey,{exp:86400});for(var t=s.length,n=0;t>n;n++){var i=s[n],r=i.url,o=i.date,l=i.topic,c=i.source,p=i.miniimg,u=i.recommendtype?i.recommendtype:"-1",m=i.hotnews,w=i.ispicnews,f=i.type,y=i.subtype,g=p.length,h=i.rowkey,v=Number(i.hotnews),_=Number(i.isvideo),T=Number(i.isrecom),x=Number(i.isnxw),k=i.urlpv,j=i.picnums,U=i.praisecnt,$=i.tramplecnt,C="";v?(C='<i class="hot">热门</i>',_&&(C+='<i class="video">视频</i>')):T?C='<i class="rec">推荐</i>':_?C='<i class="video">视频</i>':x&&(C='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.idx+n+1)+"&recommendtype="+u+"&ishot="+m+"&fr="+a.newsType,"meinv"==a.newsType?d.append('<section class="news-item news-item-s4"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'"></div></div></a><div class="options"><span class="num">'+j+' 图</span><span class="view">'+k+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+h+'">'+U+'</span><span class="J-bad bad" data-rowkey="'+h+'">'+$+"</span></div></section>"):"1"==w?(p=i.lbimg,d.append('<section class="news-item news-item-s3"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'"></div><p class="clearfix"><em class="fl">'+(C?C:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>")):g>=3?d.append('<section class="news-item news-item-s2"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+p[0].src+'"></div><div class="img fl"><img class="lazy" src="'+p[1].src+'"></div><div class="img fl"><img class="lazy" src="'+p[2].src+'"></div></div><p class="clearfix"><em class="fl">'+(C?C:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>"):d.append('<section class="news-item news-item-s1"><a data-type="'+f+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(C?C:getSpecialTimeStr(o))+'</em><em class="fr">'+c+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+p[0].src+'"></div></div></a></section>')}b.set("idx_"+a.newsType,a.idx+t,{exp:1200}),b.set("news_"+a.newsType,d.html(),{exp:1200})}},new e});