$(function(){function e(){var e=U.get("current_newstype");this.newsType=e?e:"toutiao",this.readUrl="",this.userId="",this.idx=0,this.pgNum=1,this.pulldown_pgNum=0,this.pulldown_idx=0,this.pulldown_num=0,this.qid=getQueryString("qid"),this.pullUpFlag=!0,this.startKey="",this.endKey="",this.osType=getOsType(),this.browserType=getBrowserType(),this.init()}FastClick.attach(document.body);var a="http://toutiao.eastday.com/toutiao_h5/RefreshJP",s="http://toutiao.eastday.com/toutiao_h5/pulldown",t="http://toutiao.eastday.com/toutiao_h5/NextJP",n="http://position.dfshurufa.com/position/get",i="http://toutiao.eastday.com/getwapdata/getuid",r="http://toutiao.eastday.com/pjson/zan",o="http://123.59.60.170/getwapdata/data",l="http://123.59.60.170/online/online",p="http://123.59.60.170/getwapdata/advshow",c="http://123.59.60.170/getwapdata/ad",d=$("body"),u=[],m=[],f=$("#J_news_list"),w=$("#J_refresh"),y=$("#J_top_menu"),h=!0,g=0,v=0,_=!0,T=!1,x=!1,b=null,k=200,j=null,U=new WebStorageCache;e.prototype={init:function(){function e(e,s,t){var n=e.data("rowkey"),i=a.getPraiseTrampleStatus(n);return 1===i?void alert("您已经赞过了！"):-1===i?void alert("您已经踩过了！"):void(h&&(h=!1,e.addClass("active").text(Number(e.text())+1),$.ajax({url:r,dataType:"jsonp",data:{colname:s,rowkey:n,praisecnt:1},jsonp:"jsonpcallback",success:function(e){a.cachePraiseTrampleRowkey(t,n),h=!0},error:function(e){console.error(e)}})))}var a=this;a.qid?a.setQid(a.qid):Cookies.remove("qid",{path:""}),a.userId=a.getUid(),a.userId||a.setUid(),a.readUrl=U.get("read_url_all"),a.readUrl||(a.readUrl=""),a.initChannels(function(){var e=y.children("a");e.each(function(){var e=$(this),a=e.data("type");u.push(a),"meinv"!==a&&"nuanwen"!==a&&m.push(a)}),e.each(function(){var e=$(this);return e.data("type")==a.newsType?(a.scrollTo(e),!1):void 0}),U.get("location")?a.updateDomLocation(U.get("location")):a.location()}),a.refreshData(function(){a.highlightPraiseTrample()}),a.pullDown(),y.on("click","a",function(){var e=$(this),s=e.data("type");a.scrollTo(e),U.set("prev_newstype",a.newsType,{exp:1200}),U.set("current_newstype",s,{exp:1200}),a.newsType=s,a.refreshData(function(){a.highlightPraiseTrample()}),a.addLog()}),$(window).on("scroll",function(){var e=getScrollTop(),s=$("#J_loading").offset().top,t=getClientHeight(),n=null;n&&clearTimeout(n),n=setTimeout(function(){U.set("news_pos_"+a.newsType,e,{exp:1200})},200),s>=t&&e+t>=s&&a.pullUpFlag&&a.pullUpLoadData()}),w.on("click",function(){w.hasClass("active")||(a.changeRefreshStatus(),U["delete"]("news_pos_"+a.newsType),U["delete"]("news_"+a.newsType),a.refreshData(function(){a.highlightPraiseTrample()}))}),f.on("click","a",function(e){var s=$(this),t=s.attr("href");t=t.substring(t.indexOf("/mobile/")+8,t.indexOf(".html")),a.cacheReadUrl(t,s.data("type"),s.data("subtype"))}),d.on("click",".J-read-position",function(){d.scrollTop(0),d.find(".J-read-position").remove(),a.changeRefreshStatus(),a.pullDownLoadData()}),d.on("click",".J-promote-news",function(){var e=$(this),s=e.attr("href"),t=e.data("advid");a.sendPromoteNewslog(s,t)}),f.on("click",".J-good",function(){e($(this),"z0000",1)}),f.on("click",".J-bad",function(){e($(this),"zd0000",-1)}),a.addOnlineLog(),setInterval(function(){a.addOnlineLog()},1e4)},changeRefreshStatus:function(){w.addClass("active"),setTimeout(function(){w.removeClass("active")},700)},initChannels:function(e){var a=this,s=U.get("news_channels");s?(a.generateChannelTabs(s),e&&e()):$.ajax({url:"data/channels.json",dataType:"json",success:function(s){a.generateChannelTabs(s.channels.up),e&&e()},error:function(){console.error(arguments)}})},sendPromoteNewslog:function(e,a){var s=this,t=getPixel();$.ajax({url:c,dataType:"jsonp",data:{qid:s.qid,uid:s.userId,loginid:"null",softtype:"news",softname:"eastday_wapnews",newstype:"ad",from:"null",to:e,os_type:getOsType(),browser_type:getBrowserType(),pixel:t.w+"*"+t.h,ime:"null",refer:getReferrer(),adv:a},jsonp:"jsonpcallback",success:function(e){}})},generateChannelTabs:function(e){if(e&&e instanceof Array){for(var a="",s=0;s<e.length;s++)a+=0===s?'<a class="active" data-type="'+e[s].name+'">'+e[s].value+"</a>":'<a data-type="'+e[s].name+'">'+e[s].value+"</a>";y.html(a),U.set("news_channels",e)}},getMyChannels:function(e,a){if(!e||!a)return[];for(var s=new Array,t=a.length,n=e.length,i=0;t>i;i++)for(var r=0;n>r;r++)a[i].name==e[r].name&&s.push(a[i]);return s},pullDown:function(){var e=this;f.on("touchstart",function(e){clearTimeout(j),g=e.touches[0].pageY,x=d.scrollTop()<=0,b?b.removeClass("active").css({display:"block",opacity:0,transform:"scale(0.2) translateY(0px)","-webkit-transform":"scale(0.2) translateY(0px)"}):b=$('<div class="pulldown-loading"><div class="spinner"><div class="bounce bounce1"></div> <div class="bounce bounce2"></div> <div class="bounce bounce3"></div></div></div>')}),f.on("touchend",function(){v===k?(b&&b.addClass("active"),clearTimeout(j),j=setTimeout(function(){e.pullDownLoadData()},400)):b&&b.animate({opacity:0,scale:"0.2",translateY:"0"},"fast",function(){b.remove()}),_=!0,T=!1}),f.on("touchmove",function(e){var a=e.touches[0].pageY;v=a-g,_&&v>0&&(T=!0,_=!1),x&&T&&(0===d.find(".pulldown-loading").length&&b.appendTo("body"),v>=k?(b.find(".bounce").css("backgroundColor","#2a90d7"),v=k):b.find(".bounce").css("backgroundColor","#d43d3d"),b.css({opacity:v/k,transform:"scale("+(.8*v/k+.2)+") translateY("+v/6+"px)","-webkit-transform":"scale("+(.8*v/k+.2)+") translateY("+v/6+"px)"}),e.preventDefault())})},pullDownLoadData:function(e){var a=this;a.readUrl=a.getReadUrl(),a.pulldown_pgNum=Number(U.get("pulldown_pgnum_"+a.newsType)),U.set("pulldown_pgnum_"+a.newsType,--a.pulldown_pgNum,{exp:86400}),a.pulldown_idx=Number(U.get("pulldown_idx_"+a.newsType)),a.pulldown_idx||(a.pulldown_idx=0),$.ajax({url:s,data:{type:a.newsType,startkey:a.startKey,lastkey:a.startKey,pgnum:a.pulldown_pgNum,idx:a.pulldown_idx,readhistory:a.readUrl,recgid:a.userId,qid:a.qid,os:a.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){},success:function(e){a.generateDomForPulldown(e)},error:function(e){console.error(e)},complete:function(){b&&b.remove(),e&&e()}})},getReadUrl:function(){var e=this,a="";return a="toutiao"==e.newsType||"weikandian"==e.newsType?U.get("read_url_all"):U.get("read_url_"+e.newsType),a?a:null},generateDomForPulldown:function(e){var a=this,s=e&&e.data,t=s.length;if(!s||!s.length)return!1;a.pulldown_num++,a.startKey=e.endkey,a.startKey=e.newkey,s.reverse(),f.prepend('<a class="J-read-position read-position">上次浏览到这里，点击刷新。</a>');for(var n=0;t>n;n++){var i=s[n],r=i.url,o=i.date,l=i.topic,p=i.source,c=i.miniimg,d=i.recommendtype?i.recommendtype:"-1",u=i.hotnews,m=i.ispicnews,w=i.isadv||"",y=i.adv_id||"",h=i.type,g=i.subtype,v=c.length,_=i.rowkey,T=Number(i.hotnews),x=Number(i.isvideo),b=Number(i.isrecom),k=Number(i.isnxw),j=i.urlpv,C=i.picnums,S=i.praisecnt,N=i.tramplecnt,q="",D="";"1"==w?(D='<i class="promote">推广</i>',q='class="J-promote-news" data-advid="'+y+'"',a.sendAdShowLog(y,r)):T?(D='<i class="hot">热门</i>',x&&(D+='<i class="video">视频</i>')):b?D='<i class="rec">推荐</i>':x?D='<i class="video">视频</i>':k&&(D='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.pulldown_idx-n-1)+"&recommendtype="+d+"&ishot="+u+"&fr="+a.newsType,"meinv"==a.newsType?f.prepend('<section class="news-item news-item-s4"><a data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+c[0].src+'" alt="'+c[0].alt+'"></div></div></a><div class="options"><span class="num">'+C+' 图</span><span class="view">'+j+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+_+'">'+S+'</span><span class="J-bad bad" data-rowkey="'+_+'">'+N+"</span></div></section>"):"1"==m?(c=i.lbimg,f.prepend('<section class="news-item news-item-s3"><a '+q+' data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+c[0].src+'" alt="'+c[0].alt+'"></div><p class="clearfix"><em class="fl">'+(D?D:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>")):v>=3?f.prepend('<section class="news-item news-item-s2"><a '+q+' data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+c[0].src+'" alt="'+c[0].alt+'"></div><div class="img fl"><img class="lazy" src="'+c[1].src+'" alt="'+c[1].alt+'"></div><div class="img fl"><img class="lazy" src="'+c[2].src+'" alt="'+c[2].alt+'"></div></div><p class="clearfix"><em class="fl">'+(D?D:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>"):f.prepend('<section class="news-item news-item-s1"><a '+q+' data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(D?D:getSpecialTimeStr(o))+'</em><em class="fr">'+p+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+c[0].src+'" alt="'+c[0].alt+'"></div></div></a></section>')}var P=$('<p id="J_recommend_news" class="recommend-news">为您推荐<span>'+t+"</span>条新闻</p>");if(P.appendTo("body"),setTimeout(function(){P.fadeOut("slow",function(){P.remove()})},1e3),a.pulldown_num>=20){a.pulldown_num=0;for(var J=f.children(),L=J.length,n=L-1;n>=L-20;n--)J[n].remove()}U.set("pulldown_idx_"+a.newsType,a.pulldown_idx-t,{exp:1200}),U.set("news_"+a.newsType,f.html(),{exp:1200})},sendAdShowLog:function(e,a){var s=this,t=getPixel();$.ajax({url:p,dataType:"jsonp",data:{qid:s.qid,uid:s.userId,loginid:"null",softtype:"news",softname:"eastday_wapnews",newstype:"ad",from:"null",advurl:a,os_type:getOsType(),browser_type:getBrowserType(),fr_url:"null",pixel:t.w+"*"+t.h,ime:"null",adv:e},jsonp:"jsonpcallback",success:function(e){}})},highlightPraiseTrample:function(){var e=this;"meinv"==e.newsType&&(f.find(".J-good").each(function(){var a=$(this);1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}),f.find(".J-bad").each(function(){var a=$(this);-1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}))},getPraiseTrampleStatus:function(e){var a=U.get("praise_rowkey"),s=U.get("trample_rowkey");return a&&-1!=a.indexOf(e)?1:s&&-1!=s.indexOf(e)?-1:0},cachePraiseTrampleRowkey:function(e,a){var s=U.get("praise_trample_rowkey"),t=U.get("praise_rowkey"),n=U.get("trample_rowkey");s?s+=","+a:s=a,U.set("praise_trample_rowkey",s,{exp:31536e3}),1===e?(t?t+=","+a:t=a,U.set("praise_rowkey",t,{exp:31536e3})):(n?n+=","+a:n=a,U.set("trample_rowkey",n,{exp:31536e3}))},location:function(){var e=this;$.ajax({url:n,dataType:"jsonp",jsonp:"jsonpcallback",success:function(a){try{var s=a.position,t=e.getCityPinyin(s.provname),n=null;t&&(n={prov_id:s.pro_id,prov_py:t,prov_name:s.provname},e.updateDomLocation(n),U.set("location",n,{exp:2592e3}))}catch(i){console.error(i)}},error:function(e,a){console.error(a)}})},updateDomLocation:function(e){y.children("a").eq(1).after('<a data-type="'+e.prov_py+'">'+e.prov_name+"</a>")},getCityPinyin:function(e){switch(e){case"上海":return"shanghai";case"北京":return"beijing";case"河南":return"henan";case"广东":return"guangdong";default:return null}},cacheReadUrl:function(e,a,s){var t=this;if(!t.existReadUrl(e)&&m.contains(a)){var n=U.get("read_url_all");if(n){for(n=n.split(",");n.length>=5;)n.shift();n.push(e),t.readUrl=n.join(",")}else t.readUrl=e;U.set("read_url_all",t.readUrl,{exp:1200});var i=U.get("read_url_"+a);if(i){for(i=i.split(",");i.length>=3;)i.shift();i.push(e),i=i.join(",")}else i=e;if(U.set("read_url_"+a,i,{exp:1200}),s){var r=U.get("read_url_"+s);if(r){for(r=r.split(",");r.length>=3;)r.shift();r.push(e),r=r.join(",")}else r=e;U.set("read_url_"+s,r,{exp:1200})}}},existReadUrl:function(e){var a=U.get("read_url_all");return!(!a||-1===a.indexOf(e))},clearPosition:function(e){U["delete"]("news_pos_"+e)},scrollTo:function(e){var a=y.children("a");a.removeClass("active"),e.addClass("active"),y.scrollLeft(e[0].offsetLeft-3*a.eq(0).width())},setQid:function(e){e&&Cookies.set("qid",e,{expires:365,path:"/",domain:"eastday.com"})},getQid:function(){var e=Cookies.get("qid");return e?e:""},setUid:function(){var e=this;$.ajax({url:i,dataType:"jsonp",data:{softtype:"news",softname:"eastday_wapnews"},jsonp:"jsonpcallback",success:function(a){try{e.userId=a.uid,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})}catch(s){console.error(s)}},error:function(e){console.error(e)}})},getUid:function(){var e=Cookies.get("user_id");return e?e:""},addLog:function(){var e=getPixel(),a=this;$.ajax({url:o,data:{qid:a.qid,uid:a.userId,softtype:"news",softname:"eastday_wapnews",newstype:a.newsType,from:U.get("prev_newstype"),to:U.get("current_newstype"),os_type:getOsType(),browser_type:getBrowserType(),pixel:e.w+"*"+e.h,fr_url:getReferrer(),loginid:"null",ime:"",idx:"",ishot:"",ver:"",appqid:"",ttloginid:"",apptypeid:"",appver:"",recommendtype:"",ispush:""},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},addOnlineLog:function(){var e=this,a=getUrlNoParams()+"	"+e.userId+"	"+e.qid+"	null	null	null	"+e.newsType+"	null	null	"+getOsType()+"	null";$.ajax({url:l,data:{param:encodeURI(a)},dataType:"jsonp",jsonp:"jsonpcallback"})},refreshData:function(e){var s=this,t=U.get("news_"+s.newsType),n=U.get("news_pos_"+s.newsType);t?(f.html(t),n&&d.scrollTop(n)):(U["delete"]("pulldown_idx_"+s.newsType),U.set("pgnum_"+s.newsType,1,{exp:1200}),s.readUrl=s.getReadUrl(),$.ajax({url:a,data:{type:s.newsType,recgid:s.userId,qid:s.qid,picnewsnum:1,readhistory:s.readUrl,idx:0,pgnum:1,os:s.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){f.html("")},success:function(e){s.generateDom(e),n&&d.scrollTop(n)},complete:function(){e&&e()}}))},pullUpLoadData:function(){var e=this;e.readUrl=e.getReadUrl(),e.pgNum=Number(U.get("pgnum_"+e.newsType)),U.set("pgnum_"+e.newsType,++e.pgNum,{exp:86400}),e.idx=Number(U.get("idx_"+e.newsType)),e.idx||(e.idx=0),$.ajax({url:t,data:{type:e.newsType,startkey:e.startKey,newsnum:"meinv"==e.newsType?10:20,qid:e.qid,readhistory:e.readUrl,idx:e.idx,recgid:e.userId,pgnum:e.pgNum,os:e.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){e.pullUpFlag=!1},success:function(a){e.generateDom(a)},error:function(e,a){console.error(a)},complete:function(){e.pullUpFlag=!0}})},generateDom:function(e){var a=this,s=e&&e.data;if(!s||!s.length)return!1;a.startKey=e.endkey;for(var t=s.length,n=0;t>n;n++){var i=s[n],r=i.url,o=i.date,l=i.topic,p=i.source,c=i.miniimg,d=i.recommendtype?i.recommendtype:"-1",u=i.hotnews,m=i.ispicnews,w=i.isadv||"",y=i.adv_id||"",h=i.type,g=i.subtype,v=c.length,_=i.rowkey,T=Number(i.hotnews),x=Number(i.isvideo),b=Number(i.isrecom),k=Number(i.isnxw),j=i.urlpv,$=i.picnums,C=i.praisecnt,S=i.tramplecnt,N="",q="";"1"==w?(q='<i class="promote">推广</i>',N='class="J-promote-news" data-advid="'+y+'"',a.sendAdShowLog(y,r)):T?(q='<i class="hot">热门</i>',x&&(q+='<i class="video">视频</i>')):b?q='<i class="rec">推荐</i>':x?q='<i class="video">视频</i>':k&&(q='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.idx+n+1)+"&recommendtype="+d+"&ishot="+u+"&fr="+a.newsType,"meinv"==a.newsType?f.append('<section class="news-item news-item-s4"><a data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+c[0].src+'"></div></div></a><div class="options"><span class="num">'+$+' 图</span><span class="view">'+j+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+_+'">'+C+'</span><span class="J-bad bad" data-rowkey="'+_+'">'+S+"</span></div></section>"):"1"==m?(c=i.lbimg,f.append('<section class="news-item news-item-s3"><a '+N+' data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+c[0].src+'"></div><p class="clearfix"><em class="fl">'+(q?q:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>")):v>=3?f.append('<section class="news-item news-item-s2"><a '+N+' data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+c[0].src+'"></div><div class="img fl"><img class="lazy" src="'+c[1].src+'"></div><div class="img fl"><img class="lazy" src="'+c[2].src+'"></div></div><p class="clearfix"><em class="fl">'+(q?q:getSpecialTimeStr(o))+'</em><em class="fr">'+p+"</em></p></div></a></section>"):f.append('<section class="news-item news-item-s1"><a '+N+' data-type="'+h+'" data-subtype="'+g+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(q?q:getSpecialTimeStr(o))+'</em><em class="fr">'+p+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+c[0].src+'"></div></div></a></section>')}U.set("idx_"+a.newsType,a.idx+t,{exp:1200}),U.set("news_"+a.newsType,f.html(),{exp:1200})}},new e});