$(function(){function e(){var e=k.get("current_newstype");this.newsType=e?e:"toutiao",this.readUrl="",this.userId="",this.idx=0,this.pgNum=1,this.pulldown_pgNum=0,this.pulldown_idx=0,this.pulldown_num=0,this.qid=getQueryString("qid"),this.pullUpFlag=!0,this.startKey="",this.endKey="",this.osType=getOsType(),this.browserType=getBrowserType(),this.init()}FastClick.attach(document.body);var a="http://toutiao.eastday.com/toutiao_h5/RefreshJP",s="http://toutiao.eastday.com/toutiao_h5/pulldown",t="http://toutiao.eastday.com/toutiao_h5/NextJP",n="http://position.dfshurufa.com/position/get",i="http://toutiao.eastday.com/getwapdata/getuid",r="http://toutiao.eastday.com/pjson/zan",o="http://123.59.60.170/getwapdata/data",l="http://123.59.60.170/online/online",c=$("body"),p=[],d=[],u=$("#J_news_list"),m=$("#J_refresh"),f=$("#J_top_menu"),w=!0,y=0,h=0,g=!0,v=!1,_=!1,T=null,x=200,b=null,k=new WebStorageCache;e.prototype={init:function(){function e(e,s,t){var n=e.data("rowkey"),i=a.getPraiseTrampleStatus(n);return 1===i?void alert("您已经赞过了！"):-1===i?void alert("您已经踩过了！"):void(w&&(w=!1,e.addClass("active").text(Number(e.text())+1),$.ajax({url:r,dataType:"jsonp",data:{colname:s,rowkey:n,praisecnt:1},jsonp:"jsonpcallback",success:function(e){a.cachePraiseTrampleRowkey(t,n),w=!0},error:function(e){console.error(e)}})))}var a=this;a.qid?a.setQid(a.qid):Cookies.remove("qid",{path:""}),a.userId=a.getUid(),a.userId||a.setUid(),a.readUrl=k.get("read_url_all"),a.readUrl||(a.readUrl=""),a.initChannels(function(){var e=f.children("a");e.each(function(){var e=$(this),a=e.data("type");p.push(a),"meinv"!==a&&"nuanwen"!==a&&d.push(a)}),e.each(function(){var e=$(this);return e.data("type")==a.newsType?(a.scrollTo(e),!1):void 0}),k.get("location")?a.updateDomLocation(k.get("location")):a.location()}),a.refreshData(function(){a.highlightPraiseTrample()}),a.pullDown(),f.on("click","a",function(){var e=$(this),s=e.data("type");a.scrollTo(e),k.set("prev_newstype",a.newsType,{exp:1200}),k.set("current_newstype",s,{exp:1200}),a.newsType=s,a.refreshData(function(){a.highlightPraiseTrample()}),a.addLog()}),$(window).on("scroll",function(){var e=getScrollTop(),s=$("#J_loading").offset().top,t=getClientHeight(),n=null;n&&clearTimeout(n),n=setTimeout(function(){k.set("news_pos_"+a.newsType,e,{exp:1200})},200),s>=t&&e+t>=s&&a.pullUpFlag&&a.pullUpLoadData()}),m.on("click",function(){m.hasClass("active")||(a.changeRefreshStatus(),k["delete"]("news_pos_"+a.newsType),k["delete"]("news_"+a.newsType),a.refreshData(function(){a.highlightPraiseTrample()}))}),u.on("click","a",function(e){var s=$(this),t=s.attr("href");t=t.substring(t.indexOf("/mobile/")+8,t.indexOf(".html")),a.cacheReadUrl(t,s.data("type"),s.data("subtype"))}),c.on("click",".J-read-position",function(){c.scrollTop(0),c.find(".J-read-position").remove(),a.changeRefreshStatus(),a.pullDownLoadData()}),u.on("click",".J-good",function(){e($(this),"z0000",1)}),u.on("click",".J-bad",function(){e($(this),"zd0000",-1)}),a.addOnlineLog(),setInterval(function(){a.addOnlineLog()},1e4)},changeRefreshStatus:function(){m.addClass("active"),setTimeout(function(){m.removeClass("active")},700)},initChannels:function(e){var a=this,s=k.get("news_channels");s?(a.generateChannelTabs(s),e&&e()):$.ajax({url:"data/channels.json",dataType:"json",success:function(s){a.generateChannelTabs(s.channels.up),e&&e()},error:function(){console.error(arguments)}})},generateChannelTabs:function(e){if(e&&e instanceof Array){for(var a="",s=0;s<e.length;s++)a+=0===s?'<a class="active" data-type="'+e[s].name+'">'+e[s].value+"</a>":'<a data-type="'+e[s].name+'">'+e[s].value+"</a>";f.html(a),k.set("news_channels",e)}},getMyChannels:function(e,a){if(!e||!a)return[];for(var s=new Array,t=a.length,n=e.length,i=0;t>i;i++)for(var r=0;n>r;r++)a[i].name==e[r].name&&s.push(a[i]);return s},pullDown:function(){var e=this;u.on("touchstart",function(e){clearTimeout(b),y=e.touches[0].pageY,_=$("body").scrollTop()<=0,T?T.removeClass("active").css({display:"block",opacity:0,transform:"scale(0.2) translateY(0px)","-webkit-transform":"scale(0.2) translateY(0px)"}):T=$('<div class="pulldown-loading"><div class="spinner"><div class="bounce bounce1"></div> <div class="bounce bounce2"></div> <div class="bounce bounce3"></div></div></div>')}),u.on("touchend",function(){h===x?(T&&T.addClass("active"),clearTimeout(b),b=setTimeout(function(){e.pullDownLoadData()},400)):T&&T.animate({opacity:0,scale:"0.2",translateY:"0"},"fast",function(){T.remove()}),g=!0,v=!1}),u.on("touchmove",function(e){var a=e.touches[0].pageY;h=a-y,g&&h>0&&(v=!0,g=!1),_&&v&&(0===$("body").find(".pulldown-loading").length&&T.appendTo("body"),h>=x?(T.find(".bounce").css("backgroundColor","#2a90d7"),h=x):T.find(".bounce").css("backgroundColor","#d43d3d"),T.css({opacity:h/x,transform:"scale("+(.8*h/x+.2)+") translateY("+h/6+"px)","-webkit-transform":"scale("+(.8*h/x+.2)+") translateY("+h/6+"px)"}),e.preventDefault())})},pullDownLoadData:function(e){var a=this;a.readUrl=a.getReadUrl(),a.pulldown_pgNum=Number(k.get("pulldown_pgnum_"+a.newsType)),k.set("pulldown_pgnum_"+a.newsType,--a.pulldown_pgNum,{exp:86400}),a.pulldown_idx=Number(k.get("pulldown_idx_"+a.newsType)),a.pulldown_idx||(a.pulldown_idx=0),$.ajax({url:s,data:{type:a.newsType,startkey:a.startKey,lastkey:a.startKey,pgnum:a.pulldown_pgNum,idx:a.pulldown_idx,readhistory:a.readUrl,recgid:a.userId,qid:a.qid,os:a.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){},success:function(e){a.generateDomForPulldown(e)},error:function(e){console.error(e)},complete:function(){T&&T.remove(),e&&e()}})},getReadUrl:function(){var e=this,a="";return a="toutiao"==e.newsType||"weikandian"==e.newsType?k.get("read_url_all"):k.get("read_url_"+e.newsType),a?a:null},generateDomForPulldown:function(e){var a=this,s=e&&e.data,t=s.length;if(!s||!s.length)return!1;a.pulldown_num++,a.startKey=e.endkey,a.startKey=e.newkey,s.reverse(),u.prepend('<a class="J-read-position read-position">上次浏览到这里，点击刷新。</a>');for(var n=0;t>n;n++){var i=s[n],r=i.url,o=i.date,l=i.topic,c=i.source,p=i.miniimg,d=i.recommendtype?i.recommendtype:"-1",m=i.hotnews,f=i.ispicnews,w=i.type,y=i.subtype,h=p.length,g=i.rowkey,v=Number(i.hotnews),_=Number(i.isvideo),T=Number(i.isrecom),x=Number(i.isnxw),b=i.urlpv,j=i.picnums,U=i.praisecnt,C=i.tramplecnt,S="";v?(S='<i class="hot">热门</i>',_&&(S+='<i class="video">视频</i>')):T?S='<i class="rec">推荐</i>':_?S='<i class="video">视频</i>':x&&(S='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.pulldown_idx-n-1)+"&recommendtype="+d+"&ishot="+m+"&fr="+a.newsType,"meinv"==a.newsType?u.prepend('<section class="news-item news-item-s4"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'" alt="'+p[0].alt+'"></div></div></a><div class="options"><span class="num">'+j+' 图</span><span class="view">'+b+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+g+'">'+U+'</span><span class="J-bad bad" data-rowkey="'+g+'">'+C+"</span></div></section>"):"1"==f?(p=i.lbimg,u.prepend('<section class="news-item news-item-s3"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'" alt="'+p[0].alt+'"></div><p class="clearfix"><em class="fl">'+(S?S:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>")):h>=3?u.prepend('<section class="news-item news-item-s2"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+p[0].src+'" alt="'+p[0].alt+'"></div><div class="img fl"><img class="lazy" src="'+p[1].src+'" alt="'+p[1].alt+'"></div><div class="img fl"><img class="lazy" src="'+p[2].src+'" alt="'+p[2].alt+'"></div></div><p class="clearfix"><em class="fl">'+(S?S:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>"):u.prepend('<section class="news-item news-item-s1"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(S?S:getSpecialTimeStr(o))+'</em><em class="fr">'+c+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+p[0].src+'" alt="'+p[0].alt+'"></div></div></a></section>')}var D=$('<p id="J_recommend_news" class="recommend-news">为您推荐<span>'+t+"</span>条新闻</p>");if(D.appendTo("body"),setTimeout(function(){D.fadeOut("slow",function(){D.remove()})},1e3),a.pulldown_num>=20){a.pulldown_num=0;for(var N=u.children(),q=N.length,n=q-1;n>=q-20;n--)N[n].remove()}k.set("pulldown_idx_"+a.newsType,a.pulldown_idx-t,{exp:1200}),k.set("news_"+a.newsType,u.html(),{exp:1200})},highlightPraiseTrample:function(){var e=this;"meinv"==e.newsType&&(u.find(".J-good").each(function(){var a=$(this);1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}),u.find(".J-bad").each(function(){var a=$(this);-1===e.getPraiseTrampleStatus(a.data("rowkey"))&&a.addClass("active")}))},getPraiseTrampleStatus:function(e){var a=k.get("praise_rowkey"),s=k.get("trample_rowkey");return a&&-1!=a.indexOf(e)?1:s&&-1!=s.indexOf(e)?-1:0},cachePraiseTrampleRowkey:function(e,a){var s=k.get("praise_trample_rowkey"),t=k.get("praise_rowkey"),n=k.get("trample_rowkey");s?s+=","+a:s=a,k.set("praise_trample_rowkey",s,{exp:31536e3}),1===e?(t?t+=","+a:t=a,k.set("praise_rowkey",t,{exp:31536e3})):(n?n+=","+a:n=a,k.set("trample_rowkey",n,{exp:31536e3}))},location:function(){var e=this;$.ajax({url:n,dataType:"jsonp",jsonp:"jsonpcallback",success:function(a){try{var s=a.position,t=e.getCityPinyin(s.provname),n=null;t&&(n={prov_id:s.pro_id,prov_py:t,prov_name:s.provname},e.updateDomLocation(n),k.set("location",n,{exp:2592e3}))}catch(i){console.error(i)}},error:function(e,a){console.error(a)}})},updateDomLocation:function(e){f.children("a").eq(1).after('<a data-type="'+e.prov_py+'">'+e.prov_name+"</a>")},getCityPinyin:function(e){switch(e){case"上海":return"shanghai";case"北京":return"beijing";case"河南":return"henan";case"广东":return"guangdong";default:return null}},cacheReadUrl:function(e,a,s){var t=this;if(!t.existReadUrl(e)&&d.contains(a)){var n=k.get("read_url_all");if(n){for(n=n.split(",");n.length>=5;)n.shift();n.push(e),t.readUrl=n.join(",")}else t.readUrl=e;k.set("read_url_all",t.readUrl,{exp:1200});var i=k.get("read_url_"+a);if(i){for(i=i.split(",");i.length>=3;)i.shift();i.push(e),i=i.join(",")}else i=e;if(k.set("read_url_"+a,i,{exp:1200}),s){var r=k.get("read_url_"+s);if(r){for(r=r.split(",");r.length>=3;)r.shift();r.push(e),r=r.join(",")}else r=e;k.set("read_url_"+s,r,{exp:1200})}}},existReadUrl:function(e){var a=k.get("read_url_all");return!(!a||-1===a.indexOf(e))},clearPosition:function(e){k["delete"]("news_pos_"+e)},scrollTo:function(e){var a=f.children("a");a.removeClass("active"),e.addClass("active"),f.scrollLeft(e[0].offsetLeft-3*a.eq(0).width())},setQid:function(e){e&&Cookies.set("qid",e,{expires:365,path:"/",domain:"eastday.com"})},getQid:function(){var e=Cookies.get("qid");return e?e:""},setUid:function(){var e=this;$.ajax({url:i,dataType:"jsonp",data:{softtype:"news",softname:"eastday_wapnews"},jsonp:"jsonpcallback",success:function(a){try{e.userId=a.uid,Cookies.set("user_id",e.userId,{expires:365,path:"/",domain:"eastday.com"})}catch(s){console.error(s)}},error:function(e){console.error(e)}})},getUid:function(){var e=Cookies.get("user_id");return e?e:""},addLog:function(){var e=getPixel(),a=this;$.ajax({url:o,data:{qid:a.qid,uid:a.userId,softtype:"news",softname:"eastday_wapnews",newstype:a.newsType,from:k.get("prev_newstype"),to:k.get("current_newstype"),os_type:getOsType(),browser_type:getBrowserType(),pixel:e.w+"*"+e.h,fr_url:getReferrer(),loginid:"null",ime:"",idx:"",ishot:"",ver:"",appqid:"",ttloginid:"",apptypeid:"",appver:"",recommendtype:"",ispush:""},dataType:"jsonp",jsonp:"jsonpcallback",success:function(){},error:function(){console.error(arguments)}})},addOnlineLog:function(){var e=this,a=getUrlNoParams()+"	"+e.userId+"	"+e.qid+"	null	null	null	"+e.newsType+"	null	null	"+getOsType()+"	null";$.ajax({url:l,data:{param:encodeURI(a)},dataType:"jsonp",jsonp:"jsonpcallback"})},refreshData:function(e){var s=this,t=k.get("news_"+s.newsType),n=k.get("news_pos_"+s.newsType);t?(u.html(t),n&&$("body").scrollTop(n)):(k["delete"]("pulldown_idx_"+s.newsType),k.set("pgnum_"+s.newsType,1,{exp:1200}),s.readUrl=s.getReadUrl(),$.ajax({url:a,data:{type:s.newsType,recgid:s.userId,qid:s.qid,picnewsnum:1,readhistory:s.readUrl,idx:0,pgnum:1,os:s.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){u.html("")},success:function(e){s.generateDom(e),n&&$("body").scrollTop(n)},complete:function(){e&&e()}}))},pullUpLoadData:function(){var e=this;e.readUrl=e.getReadUrl(),e.pgNum=Number(k.get("pgnum_"+e.newsType)),k.set("pgnum_"+e.newsType,++e.pgNum,{exp:86400}),e.idx=Number(k.get("idx_"+e.newsType)),e.idx||(e.idx=0),$.ajax({url:t,data:{type:e.newsType,startkey:e.startKey,newsnum:"meinv"==e.newsType?10:20,qid:e.qid,readhistory:e.readUrl,idx:e.idx,recgid:e.userId,pgnum:e.pgNum,os:e.osType},dataType:"jsonp",jsonp:"jsonpcallback",timeout:8e3,beforeSend:function(){e.pullUpFlag=!1},success:function(a){e.generateDom(a)},error:function(e,a){console.error(a)},complete:function(){e.pullUpFlag=!0}})},generateDom:function(e){var a=this,s=e&&e.data;if(!s||!s.length)return!1;a.startKey=e.endkey;for(var t=s.length,n=0;t>n;n++){var i=s[n],r=i.url,o=i.date,l=i.topic,c=i.source,p=i.miniimg,d=i.recommendtype?i.recommendtype:"-1",m=i.hotnews,f=i.ispicnews,w=i.type,y=i.subtype,h=p.length,g=i.rowkey,v=Number(i.hotnews),_=Number(i.isvideo),T=Number(i.isrecom),x=Number(i.isnxw),b=i.urlpv,j=i.picnums,U=i.praisecnt,$=i.tramplecnt,C="";v?(C='<i class="hot">热门</i>',_&&(C+='<i class="video">视频</i>')):T?C='<i class="rec">推荐</i>':_?C='<i class="video">视频</i>':x&&(C='<i class="nuanwen">暖文</i>'),r+="meinv"==a.newsType?"?fr=meinv&#&gid=1&pid=1":"?idx="+(a.idx+n+1)+"&recommendtype="+d+"&ishot="+m+"&fr="+a.newsType,"meinv"==a.newsType?u.append('<section class="news-item news-item-s4"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'"></div></div></a><div class="options"><span class="num">'+j+' 图</span><span class="view">'+b+'</span><span class="split">|</span><span class="J-good good" data-rowkey="'+g+'">'+U+'</span><span class="J-bad bad" data-rowkey="'+g+'">'+$+"</span></div></section>"):"1"==f?(p=i.lbimg,u.append('<section class="news-item news-item-s3"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><img class="lazy fl" src="'+p[0].src+'"></div><p class="clearfix"><em class="fl">'+(C?C:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>")):h>=3?u.append('<section class="news-item news-item-s2"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap"><h3>'+l+'</h3><div class="img-wrap clearfix"><div class="img fl"><img class="lazy" src="'+p[0].src+'"></div><div class="img fl"><img class="lazy" src="'+p[1].src+'"></div><div class="img fl"><img class="lazy" src="'+p[2].src+'"></div></div><p class="clearfix"><em class="fl">'+(C?C:getSpecialTimeStr(o))+'</em><em class="fr">'+c+"</em></p></div></a></section>"):u.append('<section class="news-item news-item-s1"><a data-type="'+w+'" data-subtype="'+y+'" href="'+r+'"><div class="news-wrap clearfix"><div class="txt-wrap fr"><h3>'+l+'</h3> <p><em class="fl">'+(C?C:getSpecialTimeStr(o))+'</em><em class="fr">'+c+'</em></p></div><div class="img-wrap fl"><img class="lazy" src="'+p[0].src+'"></div></div></a></section>')}k.set("idx_"+a.newsType,a.idx+t,{exp:1200}),k.set("news_"+a.newsType,u.html(),{exp:1200})}},new e});